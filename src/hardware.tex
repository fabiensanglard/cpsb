\chapter{Hardware}
\index{CP-System!CPS-1}
The project that would later be dubbed by the press "superchip"\cite{tgm198906} started between 1985 and 1986. It was a massive investment that would require two years and five million dollars\cite{becareful} (the equivalent of \$12 million in 2022).

The significant time and funds invested left no ambiguity in the mind of Capcom executives. This project would dictate the life or death of the company.

\begin{q}{Yoshiki Okamoto, Capcom Producer\cite{gamest38}}
The CP-System is an extremely important business strategy to Capcom: we have gambled everything on it.
\end{q}

\section{Goals}
The CPS-1 was expected to solve most of Capcom's arcade division problems. Namely: reduce production cost, lower selling price, streamline development, increase GFX/SFX/processing capabilities, and stop piracy. 

Cost reduction would be achieved by mimicking home consoles and standardizing the platform. Instead of re-designing boards for each game, the hardware would be a constant with the cabinet differentiated only by the software running on it.

Price lowering would allow arcade operators to replace their games more often. This objective would be reached by designing a platform where new game boards containing mostly ROMs could be purchased separately from the processor board.

The development toolchain would improve thanks to the stability of the target platform. Without having to constantly rewrite tools and juggle with assembly languages, programmers could invest in the long term and build an SDK running on powerful workstations such as SHARP's series of X68000s.

Most importantly, games had to catch customer eyes and not pale in comparison to the competition. The goal was to design a machine with capabilities an order of magnitude above the current tech stack, able to generate audio and visuals that held their own compared to titles from powerhouses such as Sega or Namco.

Finally was the problem of piracy. In a country like Mexico it was estimated that 200,000 PCB bootlegs were in circulation\cite{sf2_oral_history} despite Capcom recording no sales in that territory. Multiple concurrent copy-protection mechanisms needed to be implemented.



\section{JAMMA}



\begin{wrapfigure}[20]{r}{0.31\textwidth}
\vspace{-\baselineskip}
\centering
  \sdraw{0.31}{cabinet}
\end{wrapfigure}


% \begingroup
Arcade operators frequently updated their cabinets by replacing the game it ran in order to keep bringing novelty to players and quarters to their pockets. Thanks to the \textbf{J}apan \textbf{A}musement \textbf{M}achine and \textbf{M}arketing \textbf{A}ssociation, the process of updating was simple. 

The belly of these machines usually hid an abomination of tangled wires converging in a JAMMA harness where the motherboard would be inserted as a slot-in. All an operator had to do was swap the old with the new PCBs.

A JAMMA port has everything a game needs to operate. Its 28 pins on each side provide inputs (four-direction joystick and three buttons per player, two coin sensors, start button, and service button), outputs (mono speakers lines and "monitor" controls), and even power supply.

The problem with such a standard is that while it improves interoperability, it also hinders innovation. 

A few pins on the port are not reserved for a specific usage but they could not be used for extra features since once the harness was wired, operators did not want to touch it.



 \begin{figure}[H]
\draw{jamma_t}
\caption*{JAMMA parts side pins}
\end{figure}

 \begin{figure}[H]
\draw{jamma_b}
\caption*{JAMMA bottom side pins}
\end{figure}



When Capcom retrofited Street Fighter 1 pneumatic buttons, they chose to do it with six buttons per player, which was three more than available in JAMMA. To circumvent the limitation, they designed a parallel input system. 

Since the three JAMMA buttons were used for punches, the extension was labeled the "kick harness".

\begin{figure}[H]

\begin{tabularx}{\textwidth}{lrX}
  \toprule    
  \textbf{Wire Color } & \textbf{ Pin \#}  & \textbf{Function } \\               
  \toprule   
  Black & 1 & GND \\
  Black & 2 & GND \\
  \toprule   
  Purple & 3 & Player 1 Light Kick \\
  Grey & 4 & Player 1 Medium Kick \\
  White & 5 & Player 1 Heavy Kick \\
  \toprule   
  & 6 & NC \\
  \toprule   
  Orange & 7 & Player 2 Light Kick\\
  Green & 8 & Player 2 Medium Kick\\
  Blue & 9 & Player 2 Heavy Kick\\
  \toprule   
  & 10 & NC \\
  \toprule   
\end{tabularx}
\caption*{Kick harness pinouts}
\end{figure}










  


\section{Physical Architecture}
 The CP-System is made of three printed circuit boards named Board "A", Board "B", and Board "C" which are stacked on top of each other.


\begin{figure}[H]
\centering
\nbdraw{arch_phy}
% \caption*{A full CPS-1 game made of three PCBs}
\end{figure}

\pagebreak
The connection points are prominent white connectors. Boards A and B are connected via four 2x32-pin connectors while the boards B and C are connected with four 2x20-pin connectors.  Once plugged into each other, the boards are manipulated as a whole with no floating parts.


The system was revised over the years. Approximately 229 variations are known to exist, including bootlegs\cite{mame_cps1_video}. The board which will be studied in this book is the one used to run "Street Fighter 2": board A "88617A-7B", board B "90629B", and board C "90628-C".

\subsection{Board A}\index{Board!Board A}
Board "A" is the platform that never changes between games. It features all but one of the chips in charge of processing data, whether it is game logic, audio, or video.

A summary look at page \pageref{fig:boarda} reveals the powerhouse of the whole system. Even an untrained eye will notice the size of the \textbf{A}pplication-\textbf{S}pecific \textbf{I}ntegrated \textbf{C}ircuit (ASIC) and the sheer number of bus lines leading to it. In the center left stands the "CPS-A", in charge of 50\% of the graphic system and its 16MHz oscillator. Just above is 384 KiB of VRAM to store a special kind of framebuffer studied in later pages.

Directly below the CPS-A is the video system and its 8 KiB of SRAM containing the palettes.

The upper right section is the control system with a Motorola m68k, a 10MHz oscillator, 64 KiB of "work" SRAM and 192KiB of GFX SRAM. 

The middle right part is where the audio system lives. It is made of a Zilog z80, a 3.58MHz oscillator, and 2 KiB of "work" SRAM. Also in this area are the audio chips dedicated to music (YM2151 and YM3012) and sound effects (OKI6295).

Finally, in the bottom part we find all the components taking care of the inputs and outputs of the JAMMA connector. Alongside are three DIP switches which an arcade operator can use to configure game parameters such as game difficulty or how many credits a coin grants.

There are many chips on these three boards but it would be a mistake to conclude that combining many processors inevitably leads to better performance. That would be ignoring issues such as bus congestion, bus size difference, bus timings or even processor endianness. 

To design an effective multi-CPUs system able to avoid both instruction and data starvation is in fact far from trivial.



\simg{0.94}{88617A.png}
\label{fig:boarda}

\sdraw{0.94}{88617A}
\label{fig:drawboarda}

\subsection{Board B}\index{Board!Board B}
   Board B is where the ROMs chip containing all the assets and instructions specific to a game are attached via DIP sockets. The chips are not soldered but push-in mounted (and easily removable).

   Even though all ROM chips are located on the same board, they are not all part of an unified data system on an unified bus. 

   ROM chips are grouped depending on the system they belong to. Each group has its own data lines connected to a dedicated bus leading to a specific processor. 

   Thirty-eight DIP slots are visible on the board. They are grouped in four ROM groups. 

\vfill
\begin{figure}[H] \label{boardb_no_chips}
  \nbimg{90629B-3.jpg}
  \caption*{Empty board B}
  \end{figure}
\pagebreak

   There are 3x8 = 24 chips, referred to as "GFX ROM", dedicated to storing GFX via sockets [1-8], sockets [10-17], and sockets [20-27] for a total of 12 MiB capacity. Because of the price of ROM, games were never budgeted to allowed the max capacity. Most titles were granted 2/4MiB, three (the Street Fighter II series) were allowed 6 MiB, and one (Dynasty Wars) got a whooping 8 MiB.

   One socket (9) with 64KiB capacity, referred as "z80 ROM", stores both the z80 instructions and the music assets (instructions for the YM2151). 

   Two sockets (18-19) accounting for 256 KiB, referred as "OKI ROM", store ADPCM samples and are directly connected to the OKI chip. 

   Finally eight ROMs holding 1 MiB, referred as "M68K ROM", are dedicated to hosting m68k instructions. Even though they are related to graphics, palettes are also stored in this ROM group. 


\vfill
\begin{figure}[H]
  \nbimg{90629B.jpg}
  \caption*{Board B with Street Fighter 2 ROMs}
  \end{figure}
\pagebreak


\nbdraw{90629B}

Observant readers will have noticed unexplained black chips. For now we'll say they are in charge of bus traffic management. In the drawing above, \icode{STF29} handles the GFX ROM and \icode{IOB1} handles the m68k ROM. As an exercise, go back to page \pageref{fig:drawboarda} and guess which chip handles which ROM/RAM group. Or don't, I am just a book.

\subsection{Board C}\index{Board!Board C}
Board "C" hosts the "CPS-B" ASICs video chip. It is in charge of the remaining 50\% of the graphic pipeline, namely mixing data from the VRAM and the GFX ROMs towards the pixel generator. Capcom also concentrated its anti-piracy measures in this chip and as a result revised board "C" many more times than board A and board B. 

This will be discussed extensively in the copy-protection section of this chapter.

\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{90628-C-2.jpg}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \nbdraw{90628-C}
\end{minipage}



\subsection{PALs}
The black chips on the drawing are called \textbf{P}rogrammable \textbf{A}rray \textbf{L}ogic (PAL). They play a crucial role in the creation of the memory maps. 

They pack boolean logic (\&, \textbar, !) between their input and output lines which simplifies the board, allows tuning the logic without changing the PCB hardware lines, and reduces the number of components.

\sdraw{0.44}{PAL16L8A}

 Often located near the memory chip group they affect, they are codenamed based on their function. Since most games use slightly different ROM layout, they usually feature different PALs, e.g: the chip which organizes the GFX ROM is named \icode{STF29} in Street Fighter II, \icode{S224B} in Final Fight, and \icode{DM620} in Ghouls'n Ghosts.



\section{Logical Architecture}
The CP-System features eight processors, organized hierarchically. Commands issued at the top are carried out to sub-systems via a chain of reports. 

There is strong isolation via layering where top systems are unable to access sub-systems resources. e.g: Control has no access to VRAM and audio ROM.

\begin{figure}[H]
\nbdraw{arch_hierarchy}
  \caption*{CP-System processor hierarchy}
  \end{figure}


The control system features a m68k in charge of coordinating inputs (joystick, buttons, coin) and outputs (video and audio). It can communicate with both the GFX and audio system main processors.

The audio system runs almost totally in isolation. It is connected to control via two 8-bit latches which the z80 actively polls to retrieve commands related to music and sound effects. Notice how these latches bridge different data bus widths since control has 16 data lines while the audio system uses 8 data lines.

The graphic system needs more communications and exposes not only its CPS-A and CPS-B registers but also the GFX RAM where the screen layout is described. The m68k and the CPS-A use the same bus to access the GFX RAM, so the demarcation is not as clean as with the audio system. This results in a bit of bus contention.  
\index{Colors!Pen}
\index{Colors!Ink}

The video system produces a stream of palette addresses. Combined with the palette SRAM (where colors are stored) and the DAC, it outputs a signal towards JAMMA. It is heavy duty in order to keep up with the 59.64Hz refresh rate desired on the screen.

\begin{figure}[H]
\nbdraw{arch}
  \caption*{CPS-1 logical architecture with data lines}
  \label{cps1_arch}
  \end{figure}


\section{Control system}\index{Systems!Control}
The control system oversees the platform. As a ruler it needs not to excel at a specific task but to be able to direct and keep tabs on many components. This is a task tailor-made for the Motorola 68000.


\subsection{Motorola 68000 CPU}\index{Processors!Motorola 68000}

 Released in 1979 and clocked at 10 MHz (later upgraded to 12 MHz), the 68000 with its two stage pipeline\cite{M68000fv} (prefetch, exec) and no internal cache was not a particularly powerful chip by late 80s standards. Its 1.7 MIPS placed it on par with an Intel 286 10MHz (1.5 MIPS). By 1989 it was already two generations old behind the 1984 M68020 (3 MIPS) and the 1987 M68030 (5 MIPS)\cite{mips}.

\nbdraw{mips}

However, this lack of speed did not prevent a plethora of manufacturers from using it as their backbone. On the list of machines adopting the m68k can be found the Atari ST, Amiga, Sega's System 16, Genesis, Sega CD, Apple Macintosh, Sharp X68000, and even SNK's Neo-Geo. It was even IBM's first choice for its PC before production issues allowed the Intel 8088 to prevail\cite{ieee20170630}. 

Performance is not what made the 68000 reign as the prime hardware design choice. The reason this CPU was so successful is because it was a great team player.

While most machines used a 16-bit address system, its 24-bit address space allowed the 68000 16 MiB of RAM, which was considered humongous at the time. This was a considerable advantage when it came to map peripherals. There was so much address space that, had they wished so, Capcom engineers could have allowed the 68000 to see all RAM and all ROM of all systems on the CPS-1.

While other CPUs used small address registers resulting in the infamous segmented addressing, Motorola gave its CPU 32-bit data and address registers. The elegant flat addressing and generous eighteen registers made it a favorite among programmers. 


\begin{figure}[H]

 
\sdraw{0.75}{68000}
 \caption*{Motorola 68000 pin-outs}
\label{68000drawing}
  \end{figure}



The 68000 is brought to life via its clock (\icode{CLK}), +5V (\icode{VCC}), and Ground (\icode{VSS}) pins.

The bus is made of \icode{D0-D7} for data and \icode{A0-A15]} for addresses while address ACK (\icode{AS}), Read/Write (\icode{R/W}), \icode{UDS}, \icode{LDS}, and Data ACK \icode{DTACK} are bus control pins.


Arbitration to allow peripherals to master the bus is done with Bus Request (\icode{BR}),  Bus Grant (\icode{BG}) and Bus Grant ACK (\icode{GBA-K}) lines.

The interrupt system is made of a generous three pins \icode{IPL0}, \icode{IPL1}, \icode{IPL2}, and \icode{VPA} for control. While other CPUs like the x86s or the z80 have a single interrupt line, the multiple \icode{IPL}s can encode an interrupt ID directly which removes the need for an interrupt controller. How this is leveraged will be explained in the programming section.

\index{Interrupts!68000}
System control is done via Error (\icode{BERR}), Reset (\icode{RST}), and Halt (\icode{HALT}). 

Finally, the processor status is given by \icode{FC0}, \icode{FC1}, \icode{FC2} and Peripheral control is done via sync (\icode{E}) and valid sig (\icode{VMA}).

\begin{trivia}
Motorola's CPU name is due to the total number of transistors totaling 68,000 units. The 68030 and 68040 had more transistors than their names indicate. 
\end{trivia}

Despite the raving description provided in the previous pages, the 68000 could be a peculiar CPU to program. Its most famous shortcoming involved memory alignment. While Intel's line of CISC allows random memory accesses (at the cost of a great performance penalty), Motorola's CPU will throw an \icode{address error} exception while attempting to read/write memory not aligned on a 16-bit (\icode{WORD}) boundary.

This limitation is rooted all the way down to the CPU pins where there is no \icode{A0} line. Pins \icode{UDS} and \icode{LDS}indicate which of the high-byte or low-byte parts of a 16-bit \icode{WORD} to access.


\begin{trivia}
 The 68000 has 32-bit address registers but used only 24-bit addresses. These "unused" eight bits were hijacked by system engineers to mark address as "locked" or "purgeable". These programs promptly broke when running on a 68020, which used a 32-bit address bus. 
\end{trivia}

Perhaps the best testament to the quality of the 68000 design is that as of 2022, 43 years after its release, Motorola's immortal CPU is still in production.


\subsection{Motorola 68000 "work" RAM}
With 16-bit data bus processors it would be fair to expect a memory system built with 16-bit RAM chips. However these were expensive and a closer look reveals a bunch of \icode{65256BLSP-10} offering fast access time (100ns SRAM) and 32 KiB capacity but only 8 data lines.

\sdraw{0.5}{65256BLSP-10}
\pagebreak

Using cheaper off-the-shelf 8-bit RAM chips instead of 16-bit RAM chips helped to drive down cost. Moreover, these are not hard to combine into a 16-bit RAM system via two-way interleave.

\begin{figure}[H]
\nbdraw{64k_ram}
\caption*{32 Ki x 16-bit RAM system with two 32 Ki x 8-bit chips}
\end{figure}

The two \icode{65256BLSP-10} are not aware of each other. They are connected to the same 15 address lines and the same control lines for Write Enabled (\icode{WE}) and Read Enabled (\icode{OE}). However, they are connected to different lines of the data bus.


 \begin{trivia}
Interleaving chips can also help to beat memory latency by increasing throughput. Early GPUs such as the Voodoo 1 and Voodoo 2 by 3Dfx extensively relied on this technique, even using four-way interleave to keep up with the bandwidth requirements\cite{TheStoryOf3Dfx}.  
 \end{trivia}


Notice how the address lines of the SRAM chips are directly connected to the 68000 address bus. There is no mechanism to prevent these two chips from responding to all bus requests. 

This is an over-simplification to introduce complexity progressively. We will see next how chips are organized to not conflict with each other.

 \begin{trivia}
 64 KiB of work RAM seems like a lot but was not always enough. Some games found themselves with not enough RAM and too much GFXRAM. Street Fighter 2 Champion Edition programmers resolved to generating and executing instructions from the GFXRAM\cite{mame_driver}!
 \end{trivia}
\pagebreak








\subsection{Motorola 68000 Program ROM}


The 68000 instructions are provided by eight \icode{27C010} which are 128 Ki x 8-bit chips. They work like the \icode{65256BLSP-10} except that they have sixteen address lines instead of fifteen (and therefore higher capacity).

Like the RAM, ROM chips are combined via two-way interleaves to provide 16-bit data. What is peculiar is how the four pairs are arranged to build a memory system with larger capacity.


\begin{figure}[H]
\nbdraw{128k_ram}
\caption*{Two first pairs. 4 x (128 Ki x 8-bit) making a 256Ki x 16-bit system}
\end{figure}

To place one pair after another in memory space, the \icode{CE} (Chip Enabled, sometimes labeled \icode{CS} for "Chip Selected") pin is leveraged. Asserting it lets a chip respond to an address request while de-asserting it keeps it dormant. All CEs on all chips on all boards are controlled via PALs.

In this example, the first four out PAL pins must be programmed as follows.

\lstinputlisting[style=CStyle]{src/code/pal.c}


The first pair of chips is mapped to addresses \icode{0x000000} while the second pair is mapped to \icode{0x40000}. With the same logic, two more pairs of \icode{27C010} are mapped at \icode{0x80000} and \icode{0xc0000} for a total of 1 MiB ROM.



By now, it should be abundantly clear that the \icode{CE} / \icode{CS} lines are absolutely crucial to build a memory map. Even though they won't be mentioned again, keep in mind they impact every chip on the boards (except the CPUs).

\subsection{68000 Memory Map}

Thanks to the PAL chips enabling/disabling components, the 68000's memory space is partitioned. The result is summarized in a "memory map".

\begin{figure}[H]
{
\begin{tabularx}{\textwidth}{rrrX}
% \toprule    
  \textbf{Start } & \textbf{End  } & \textbf{Size } & \textbf{Function } \\               
  \toprule    
  \texttt{0x000000} & \texttt{0x3FFFFF} & 3 MiB & ROM \\
  \toprule    
  \texttt{0x800000} & \texttt{0x800007} & 8 B & JAMMA Players Inputs \\
  \texttt{0x800018} & \texttt{0x80001F} & 8 B & JAMMA Dip Switches \\
  \texttt{0x800030} & \texttt{0x800037} & 8 B & JAMMA Coin sensors \\
  \texttt{0x800176} & \texttt{0x800177} & 1 B & Kick harness \\
\toprule    
  \texttt{0x800100} & \texttt{0x80013f} & 64 B & CPS-A registers\\
  \texttt{0x800140} & \texttt{0x80017f} & 64 B & CPS-B registers\\
\toprule    
  \texttt{0x800180} & \texttt{0x800187} & 8 B & Sound commands (latch 1)\\
  \texttt{0x800188} & \texttt{0x80018F} & 8 B & Sound commands (latch 2)\\
  \toprule    
  \texttt{0x900000} & \texttt{0x92FFFF} & 192 KiB & GFXRAM\\
  \texttt{0xFF0000} & \texttt{0xFFFFFF} & 64 KiB & Work RAM \\
  % \toprule    
\end{tabularx}%
}\caption*{Control system memory map}
\end{figure} \label{m68k_mm}

\subsection{Putting it all together}

The details of the 68000's operations will be studied in-depth in the next chapters but we can already guess how the CPU operates based on what it can access. As the m68k boots, it starts to retrieve instructions from its ROM. For regular operations such as store/load, and also to keep track of its call stack, it uses its work RAM. 

The game engine starts and reads the configuration set by the arcade operators via the DIP switches. While the game runs, the CPU continuously polls the JAMMA inputs.

The engine reads JAMMA inputs and delegates generation of video and audio signal to its subordinates. In turn these generate signals towards JAMMA outputs.

For the video, the m68k describes the scene to be displayed via the GFXRAM. The graphic ASICs are then instructed how to retrieve the scene data via their registers. 

For the audio, the m68k issues simple commands to the z80 via two 1 byte latches using a protocol detailed later.
  











\pagebreak
\section{Audio system}\index{Systems!Audio}
The audio system runs in isolation from everything else. It has its own bus, its own RAM, its own ROM systems, and its own oscillators. Its only opening to the outside world are two latches to receive commands from the control system and two JAMMA pins to output sound.

The component in charge is a surprisingly lightweight z80 running at 3.58 MHz.

\subsection{z80 CPU}
Released in July 1976 by Zilog, the z80 was intended as an Intel 8080 killer thanks to a compatible instruction set. It ended up becoming an icon of the 70s, sharing the scene with the equally legendary MOS 6502 well into the mid-80s. 

The z80 was widely used in home computers, notably featured in the Sinclair ZX Spectrum and the Amstrad CPC. It also found its way into military applications, musical equipment (Roland Jupiter-8), embedded systems, and multiple coin-op arcades. 

As an 8-bit era processor, the z80 uses 8-bit data registers, 8-bit data bus, 16-bit addresses, and 16-bit address bus. In terms of processing power, despite its "overlapping fetch/execute" design the CPU had become particularly weak by late 80s standards with 0.45 MIPS. It was three times slower than the 68000 featured in the control system\cite{mips}. 

\nbdraw{mips_z80}

Processing power was not the deciding factor in electing the master of the Sound system, though. Thanks to its two powerful co-processors, the CPU would not have to process much data, making the MIPS figure irrelevant. A much more important characteristic was how well it integrated with its two sidekicks.

Thanks to its 8-bit design, the z80 was a perfect fit for the 8-bit YM2151 and the 8-bit MSM6295. Having been around for a while, the "outdated" CPU was inexpensive. Lastly, it enjoyed a good reputation thanks to its simple programming interface.

\begin{trivia}
The number of pin lines on a chip dictates its packaging name. DIP (Dual In-line Package), like the z80 below, are recognizable by their two lines of pins. The Motorola 68000 on page \pageref{68000drawing} with its four sides of pins belongs to the "Chip carrier" family. 

Packaging can use materials such as plastic or ceramic in which cases they are referred to by increasingly barbaric acronyms such as CLCC or PLCC.
\end{trivia}

\sdraw{0.9}{z-80}\index{Processors!Zilog 80}

The z80 comes to life thanks to its \icode{CLK} (clock ), \icode{+V5} (power), and \icode{GND} (ground) pins.

The bus lines are dedicated \icode{D0-D15} for addresses and \icode{A0-A7} for data. For control, \icode{RD} indicates read while \icode{WR} indicates a write operation. \icode{WAIT} is used to add waitstates. 

Although it is capable of relinquishing control of the bus via \icode{BUSRQ} (Bus Request), \icode{BUSAK} (Bus Acknowledge), \icode{MREQ} (Memory Request), and \icode{IORQ} (IO Request), the z80 completely owns its bus and never shares it. In fact, the \icode{BUSRQ} and \icode{BUSAK} pins are not even connected.  Because it is isolated via latches, the z80's bus never suffers contention.


Other pins are \icode{NMI} Non Maskable Interrupt, \icode{RESET} Restart CPU, \icode{HALT} Waiting for interrupt, \icode{M1} Fetching next instruction. The \icode{INT} Interrupt line will be of crucial interest in the programming section. An interrupt controller is usually necessary but the simple needs of the sound system allows it to work without one. 
\index{Interrupts!z80}

\label{z80_pinRFSH}
The \icode{RFSH} pin (ReFreSH signal) ticks at regular intervals to trigger DRAM refreshes. Since the sound system uses only SRAM this pin was re-purposed in a creative way for the CPS-1.5 "Kabuki" (page \pageref{kabuki}).


\pagebreak

\subsection{z80 Work RAM}
The amount of RAM provided to the z80 may appear scandalously small by today's standards. However because all it has to do is forward requests from the latches to the MSM6295 and feed the YM2151 music notes, the z80 needs few resources. Its bus is connected to a single 2Ki x 8-bit \icode{CXK5816SP} chip.

\subsection{z80 ROM}
The ROM is made of a simple 64Ki x 8-bit \icode{27C512} chip. It is much larger than the RAM in order to store YM2151 instructions alongside the z80 instructions. 


These ROM chips work like those previously described, with pins such as power, ground, addresses, data, control, and of course the crucial \icode{CE}. What is peculiar is the z80 uses 16-bit address registers which allows 65,536 addresses. There is not enough address space for all registers, ROM, and RAM totaling 67 KiB.

The solution is to map only the portion of the ROM that contains instructions (32KiB) statically and to use a banking system to provide a 16 KiB "view" into the remaining 32KiB of the ROM where music assets are stored. This is accomplished simply with a PAL (\icode{SOU1}) and was a source of great pain to the developers (see page \pageref{memory_bank_programming}).


Hopefully the thought of this awful bank switch control register will leave no doubt with regards to the awesomeness of the m68k and its 24-bit flat addressing system. 

\subsection{z80 Memory Map}

\begin{figure}[H]
{
\begin{tabularx}{\textwidth}{rrrX}
\toprule    
  \textbf{Start } & \textbf{End  } & \textbf{Size } & \textbf{Function } \\               
  \toprule    
  \texttt{0x0000} & \texttt{0x7FFF} & 32 KiB & ROM (32 KiB out of 64 KiB)\\
  \texttt{0x8000} & \texttt{0xBFFF} & 16 KiB & Bank-switched view of rest of ROM\\
  \toprule    
  \texttt{0xD000} & \texttt{0xD7FF} & 2 KiB & RAM \\
\toprule    
  \texttt{0xF000} & \texttt{0xF001} & 2 B & YM2151 registers\\
  \texttt{0xF002} & \texttt{0xF002} & 1 B & OKI OKI6295 registers\\
  \texttt{0xF004} & \texttt{0xF004} & 1 B & Bank Switch control (\icode{SOU1})\\
  \texttt{0xF006} & \texttt{0xF006} & 1 B & OKI MSM6295 H / L mode\\
  \toprule    
  \texttt{0xF008} & \texttt{0xF008} & 1 B & Sound commands (latch 1)\\
  \texttt{0xF00A} & \texttt{0xF00A} & 1 B& Sound commands (latch 2)\\
  \toprule    
\end{tabularx}%
}\caption*{Audio memory map}
\end{figure}



\subsection{YM2151}\index{Processors!Yamaha 2151}

Selecting the music chip was not a matter of shopping between vendors but rather picking one from Yamaha. Thanks to the licensing of Frequency Modulation (FM) patents from Stanford in 1975, the Japanese founder ruled the world of electronic music.

\begin{trivia}
Yamaha licensed FM technology from Stanford starting in 1975 at the cost of \$10/keyboard. Licensing was renegotiated in 1985 on a per-chip basis\cite{fm_licensing}.

\end{trivia}
Three architectures stood out in the early 90s. Between the OPL2 3812, the OPN2 2612, and the OPM (\textbf{OP}erator type \textbf{M}) 2151, the latter was selected for its versatility. 



The principle of Frequency Modulation is to use simple wave forms to modulate each other in a Modulator/Carrier pair, resulting in complex waveforms\cite{fmProgramming}.

\begin{figure}[H]
\draw{fm_carrier}
\caption*{Carrier wave}
\end{figure}

\begin{figure}[H]
\draw{fm_signal}
\caption*{Modulator wave}
\end{figure}

\begin{figure}[H]
\draw{fm_result}
\caption*{Resulting wave}
\end{figure}







The YM2151 is able to play 8 channels (a.k.a voices) of audio. Each channel consists of four operators (a.k.a slots) which can be setup to produce either percussion or instrument sounds.  

Slots are even able to modulate their own output. With proper adjustments, virtually any wave form can be obtained. 
 
\begin{figure}[H]
\nbdraw{waveforms}
\caption*{Some of the wave forms the YM2151 can generate}
\end{figure}


Other parameters can be applied to a channel's output. The envelope features adjustable Attack, Decay, Sustain, and Release Rate. 

\nbdraw{adsr}

The huge advantage of FM synthesis is the small amount of data required to store a melody. After the instruments are defined, only the notes of each instrument and their tempo need to be recorded. Yamaha's technology is so efficient that in Street Fighter 2 the whole Sagat main stage music (2mn6s, 10KiB) uses fewer bytes than one Tiger Uppercut's ADPCM sample (777ms, 12KiB).




Looking at the YM2151, we see previously discussed pins such as \icode{+5V}, \icode{GND}, and \icode{CS}. The \icode{CLK} is connected to the same oscillator as the z80 for a frequency of 3.58MHz. The \icode{D0-D7} address/data pins (multiplexed via \icode{A0}) exactly fit the z80's 8-bit data bus with read (\icode{RD}) and write (\icode{WR}) control.


One pin is of particular interest to us. \icode{IRQ} allows the YM2151 to generate interrupts based on two internal counters. Its usage is detailed in the programming section.

\sdraw{0.48}{YM2151}

The only drawback of this chip is that it does not features a DAC (Digital to Analog Converter). It generates a signal on the Serial Output (\icode{SO}). 

\subsection{YM3012}\index{Processors!Yamaha 3012}

The YM3012 is a DAC connected to the YM2151 digital output \icode{SO}. The analog signal it outputs on \icode{CH1} and \icode{CH2} is mixed with the signal from the OKI6295 towards JAMMA.

\sdraw{0.95}{YM3012}


\subsection{MSM6295}\index{Processors!OKI MSM6295}

For audio sample playback, Capcom spared no expense and selected a chip capable of 4-bit ADPCM audio decompression over four channels, the MSM6295 (a.k.a OKI). 
% capable chips by the past with the MSM5205 by OKI Semiconductor. For the CPS-1  they went with a steroids version,

Despite running at only 1MHz, the MSM6295 is a god-send to a game board designer. It does not need instructions as its function is fully hard-coded. Its address (\icode{A0-A15}) and data (\icode{D0-D7}) lines are directly connected to its own 256 KiB ROM, on a local bus where assets are stored. This avoids contention with the z80 bus. 

These make it a fully enclosed digitized sound system only communicated via its input lines (\icode{I0-I7}), a perfect match for the z80 data bus, from which it receives commands.

To get to work, the OKI only needs to receive a sample ID [1-127], a channel [1-4], and a volume [0-127]. Via a lookup table in its ROM, the sample offset is retrieved and playback starts with an analog signal generated on \icode{DA0}. 

\sdraw{0.75}{MSM6295}

Up to four channels can be active simultaneously. Since games don't need that many sound effects simultaneously, two channels are usually reserved for sound effect playback while two are dedicated to embellishing music with samples.

ADPCM lossy compression is able to divide space consumption by three by converting 12-bit PCM samples into 4-bit nibbles. 


\subsubsection{Making choices}
While the choice of the Yamaha music chip left little ambiguity to the hardware designer, the MSM6295 was a different story.

First, the sampling rate expected in ROM is directly correlated to the clock rate of the MSM6295. Second, the OKI can operate in two modes via its \icode{SS} pin. In high quality (H), the divisor is 132 and in low quality (L) the divisor is 165.

Running within [1MHz-5MHz] in two modes, the goal was to maximize quality while minimizing required storage. The table below shows that the best quality (37kHz) only allowed storage of 13 seconds of samples, while the lowest quality (6060Hz) gave 86 seconds.
\begin{figure}[H]
{
\setlength\cmidrulewidth{\heavyrulewidth} % Make cmidrule = 

\begin{tabularx}{\textwidth}{Ycccc}

  & \multicolumn{2}{c}{H} &  \multicolumn{2}{c}{L} \\
  \cmidrule(lr){2-3}
  \cmidrule(lr){4-5}
  \textbf{MHz } & \textbf{Sampling Rate (Hz)} & \textbf{Time (s)} & \textbf{Sampling Rate (Hz)} & \textbf{Time (s)}\\               
  \toprule    
  \texttt{1} & 7575 & 69 & 6060 & 86\\
  \texttt{2} & 15151 & 34 & 12121 & 43\\  
  \texttt{3} & 22727 & 23 & 18181 & 28\\
  \texttt{4} & 30303 & 17 & 24242 & 21\\
  \texttt{5} & 37878 & 13 & 30303& 17\\
  \toprule    
\end{tabularx}%
}\caption*{MSM6295 operating modes (with ROM = 256 KiB).}
\end{figure}

In the end, Capcom connected the OKI to the GFX crystal (16MHz) and divided frequency by 16 to run at 1MHz. Along with a SS pin set to H, the system uses a 7,575Hz sampling rate.




\subsection{PCM 101}
\index{ADPCM!Decompression}
The MSM6295 input and output are respectively ADPCM and PCM streams. To deepen our understanding of the chip requires studying how \textbf{P}ulse-\textbf{C}ode \textbf{M}odulation works.

Whether for recording or playing, PCM is a series of values directly representing the position of a device diaphragm. In the case of recording, the diaphragm is in a microphone. In playing, it is in a loud speaker.

\pagebreak

\begin{figure}[H]
\nbdraw{speaker}
\caption*{A speaker cone moves proportionally to the PCM values}
\end{figure}


Sampling rate and bit depth are the two parameters impacting the fidelity of the signal capture/restitution.

\begin{figure}[H]
\nbdraw{pcm}
\caption*{PCM values (4-bit samples) quantizing an analog signal}
\end{figure}


The higher the sampling rate (on the X axis), the more often the cone position can be adjusted. The higher the bit depth (on the Y axis), the more accurately the cone position can be set. Stereo is achieved by interleaving two PCM streams.





Sound quality increases linearly with data rate.
\begin{itemize}[topsep=0pt]
\item Landline phones use 8,000Hz/8-bit mono using 8,000 Bytes per Second.
\item CDs use 44,100Hz/16-bit stereo using 176,400 Bytes per Second.
\end{itemize}



\subsection{ADPCM compression}
ADPCM is able to take 12-bit PCM samples and compress then as 4-bit nibbles by encoding only the difference between PCM samples. Decompressing an ADPCM stream consists of adding a delta value to the last decompressed  sample, over and over again.

The delta is encoded with a system of weighted offsets called "step", which is accurate for small variations but coarser when deltas increase. 

The first bit in a nibble indicates the sign of the delta (+/-). The three other give a "magnitude". The magnitude depends on the "step size" of the ADPCM decompressor.

\begin{figure}[H]
\sdraw{0.3}{adpcm_nibble}
\caption*{ADPCM nibble}
\end{figure}


In its initial state, the step size is 16 which means bit three is +/-16, bit two +/-8 and bit one +/-4. In this state, the delta to be applied can vary from 0 (\icode{b000}) to +/- 28 (\icode{b111}). 

The decompressor constantly monitors how much of the step size is used. The step size is adjusted after each sample via a  predetermined transition table indexed via the magnitude value. 

\lstinputlisting[style=CStyle]{src/code/adpcm_transition.c}



The transition table dictates how to adjust the step size index. ADPCM is aggressive in increasing the index for magnitude values ranging from 4 to 7 where it is bumped between \icode{2} and \icode{8}. Meanwhile it is conservative in decreasing the index for small magnitude values ranging from 0 to 3 where it is always modified in \icode{-1} decrements.








\pagebreak
\section{Video system}\index{Systems!Video}
The goal of the video system is to pilot the CRT (Cathode-Ray Tube) where images are rasterized for the player to see.

Even though it is connected via an intermediate JAMMA port, there is no abstraction layer or custom protocol. The four red, green, blue, and sync JAMMA output pins are connected directly into the CRT inputs.

\begin{figure}[H]
\nbdraw{rgb_wires}
\caption*{The four wires needed to drive a CRT}
\end{figure}


There are four wires but in fact five signals are transmitted. Each red, green, and blue signal has its own wire, while the sync wire carries two signals multiplexed as horizontal sync pulse and vertical sync pulse. Because it composes two signals, it is called CSYNC (Composite SYNC). 

These five signals are everything a CRT needs to work. 

\begin{trivia} The CRT is purely a signal consumer. It never sends anything "back" on these wires. It is a common misconception that the CRT emits VSYNC. In fact, all signals are generated by the video system.
\end{trivia}


\subsection{CRT 101}

Because the timing of operations is propagated deep in the GFX system, it is important to understand how a CRT works.

At its core, a CRT is a line-drawing machine. It draws horizontal lines one after another, from left to right and top to bottom. While it scans a line, three analog signals (one for each RGB color) indicate the quantity of electrons to shoot from three guns. The higher the signal, the more electrons shot and the more vivid the color.


On the way toward the panel, electrons are filtered through a shadow mask to make sure they hit the proper type of colored phosphor receptacles which are grouped by three in RGB "slots". The electron beam-slot is not a one to one relationship. The beam can be larger or smaller than a slot.


\begin{figure}[H]
\draw{shadow_mask}
\caption*{Electron gun, mask, and slots}
\end{figure}

Slots are not aligned horizontally. When the gun shoots electrons it doesn't really know on which slots they will land. They can hit all in one slot, or two halves of two slots, or other configurations depending on slot density and beam dispersion. 

The only guarantees are that an electron from a cannon color lands in a phosphor receptacle of the same color, and that the electron beam height is constant on a line.

\begin{figure}[H]
\draw{triad_slots}
\caption*{A scanline of electron hits wherever}
\end{figure}

Smaller slots can render the horizontal analog signals with better fidelity.


\draw{triad_slots_hd}



 With this duality of lines and signals, a CRT is both a digital and an analog system. The number of scanlines is finite (i.e: there is a set number of these elements) but there is no horizontal number of "dots", "points", or "pixels" since the three color intensity signals are analog.


\subsection{Syncing}
The RGB signals describe lines to be drawn but the CRT needs to know where to draw them. The control signal allows synchronization of the cannon orientation with the lines' color signal so they are rasterized where they should. Without syncing, the image appears distorted. 

\begin{figure}[H]
\sdraw{0.93}{desync}
\caption*{A desynced CRT. Lines are correct but not located where they should be}
\end{figure}





VSYNC signal tells the CRT it should reset the gun's vertical position to 0 at the top of the screen. This motion from bottom to top is called vertical retrace. During the retrace the gun must stop shooting electrons. This is achieved by requesting a black color on the RGB signal. This "blanking" of the RGB lines happens a little bit before and after VSYNC. The total time not drawing anything is called VBLANK.

HSYNC signal tells the CRT that a line has been drawn and the gun's horizontal position should be reset to the left of the screen. This motion is called horizontal retrace. Like the VBLANK, there is a HBLANK timespan. 

\pagebreak
\subsection{Fields}

The process of drawing scanlines over the screen, also called "raster scan", is incomplete as described. If the gun draws a line and upon HSYNC goes back to the left, it would be drawing the same upper left line over and over again. 

It is barely noticeable but scanlines are not drawn straight. There is a slight downward slope. This way, when HSYNC is received and horizontal position is reset, the next line is drawn below the previous.



\nbdraw{p_scan}

As long as VSYNC is issued at the same time as a HSYNC, the CRT lines are always on the same location on the screen.

In the next drawing, see what happens if VSYNC \circled{3} is issued in the middle of the last line being draw (between HSYNC \circled{2} and \circled{4}).

\nbdraw{i_scan}

Since only half a line was drawn at the bottom, the gun only progressed down half a space vertically. As a result, the next frame will be interlaced with the previous. This technique is used for TV broadcasts in the USA and Japan via NTSC. A signal carries frames at 30Hz, each contains two "fields" to be drawn interlaced at 60Hz.

While interlacing is acceptable for TV images, it is not for gaming, as the artifacts are disturbingly visible on moving text and sprites. 

One solution to this problem is to only use one field and never display anything on the other one. Doing this means designing a video system where VSYNC is always issued along with a HSYNC. The drawback is that since CRTs were built to display interleaved images, they provision for space between lines. 

Since this space is not used for another field, the resulting effect is black horizontal strips on the screen. Note that the problem is compensated for by line bleeding so the black lines are not as big as the visible lines.

\begin{figure}[H]
\img{sf2_4_3_interlaced.png}
\caption*{Non-interlaced scanning show a black space between lines}
\end{figure}


Besides avoiding interlacing, many other decisions had to be made.





\subsection{Making choices}

To craft a video system means building a signal generator and a color generator. We'll study the signal generator first. This circuit is built to take an oscillator ticks as input and to output three signals. One signal tells for how long the color generator should hold a color on the color lines, one signal triggers HSYNC, and one signal triggers VSYNC. 

\nbdraw{video_signal}

The oscillator feeds an "horizontal register" which increases one by one each tick. Upon reaching its max value, the register wraps around to both issue a HSYNC and increase a "vertical register". 

Likewise, when the vertical register reaches its max value, it wraps around and generates a VSYNC. 

The color duration has no register counting the ticks. Each tick indicates that a dot is being drawn.

A designer can pick any oscillator frequency (which we call dot-clock from now on). However, they must be careful to choose vertical max value (number of lines) and horizontal max value (number of dots per line) such that vertical frequency and horizontal frequency are compatible with what a CRT can sync on. 

As these CRTs of the 90s were meant to TV sets consuming NTSC broadcast so the two imperatives were to be close to \textbf{59.95 Hz} VSYNC rate and \textbf{15,734 Hz} HSYNC rate. 

\nbdraw{ntsc}


The horizontal frequency and vertical frequency are directly derived from the three values picked for the signal generator. Plugging the numbers into the following formula allows to verify how close a system is from being compatible with a CRT.

\begin{align*}
 \mathtt{Horizontal\; frequency} = \dfrac{\mathtt{dotclock}}{\mathtt{numDots}}
\end{align*}
\begin{align*}
\mathtt{Vertical\; frequency} =   \dfrac{\mathtt{dotclock}}{\mathtt{(numDots * numLines)}}
\end{align*}


Before looking at Capcom's choices, let's look at the decisions made by video designers for systems contemporary to the CP-System. 


\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrrr} 
  \textbf{ } & \textbf{Genesis (H40)\cite{h40}} & \textbf{ Neo-Geo }  & \textbf{ Super NES } \\               
  \toprule    
   \textbf{dots} & \texttt{ 420 } & \texttt{ 384 }  & \texttt{ 341 } \\ 
   \textbf{lines} & \texttt{ 262 } & \texttt{ 264 }  & \texttt{ 262 } \\ 
   \textbf{dot-clock (Hz)} & \texttt{  6,711,647 } & \texttt{ 6,000,000 }  & \texttt{ 5,369,318 } \\ 
\toprule    
   \textbf{HSYNC frequency (Hz) } & \texttt{ 15,700 } & \texttt{ 15,625 }  & \texttt{ 15,745 } \\ 
   \textbf{VSYNC frequency (Hz) } & \texttt{ 59,92 } & \texttt{ 59.18 }  & \texttt{ 60.09 } \\ 
\toprule    

\end{tabularx}%
}\caption*{Signal generator values for Genesis, Neo-Geo, and Super NES}
\end{figure}

Keep in mind that these resolutions are not what programmers can count on. Because of overhead discussed in the next section, some lines and dots are unavailable. The resolutions presented here are called "overscan resolutions".


\subsubsection{Capcom video signal choices}

The CPS-1 uses an overscan resolution of \icode{512x262}. The dot-clock is 8 Mhz which is obtained by halving the CPS-A/CPS-B 16 MHz clock (it spares an oscillator chip).

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xr} 
  \textbf{ } & \textbf{CP-System} \\
  \toprule    
   \textbf{dots} & \texttt{512} \\
   \textbf{lines} & \texttt{262} \\
   \textbf{dot clock (Hz)} & \texttt{8,000,000} \\
\toprule    
   \textbf{HSYNC frequency (Hz)} & \texttt{15,625} \\
   \textbf{VSYNC frequency (Hz)} & \texttt{59.6374} \\
\toprule    

\end{tabularx}%
}\caption*{Signal generator values for CP-System}
\end{figure}

Besides these vertical and horizontal frequency "rules", Capcom engineers had additional constraints. Because the graphic system works with tiles (which we will study in the next section) using sizes of 8, 16, or 32 pens, both axis dimensions had to be multiples of eight.

\subsubsection{Blanking}

The CP-System overscan resolution of \icode{512x262} seems to indicate a very high resolution for the time. But not all lines and dots on a line can be used, some have to be sacrificed to solve three problems. 

First, there is the problem of retracing vertically and horizontally. Cannon movement is not instantaneous, so while it moves horizontally or vertically, it would leave a visible diagonal of electrons across two scanlines (horizontal reset) or across the whole screen (vertical reset).

The second problem is wobbling. Because a reset changes the cannon position abruptly (as opposed to the smooth progression during a scanline), it takes a little bit of time for the electron beam to stabilize again after it completes the reset.

Lastly, the video system needs breaks to read or write data without generating visible artifacts. This includes swapping buffers, updating palette colors, and retrieving the list of sprites/tilemaps to draw on the next scanline.

The solution to these three problems is named blanking. By setting the color signals to zero, the cannon shoots no electrons. Blanking hides artifacts and create a window of time where the video system is inactive. There is a vertical blanking called VBLANK and an horizontal blanking called HBLANK.


\subsubsection{Capcom's second set of video signal choices}

Out of the 262 total lines available, Capcom decided to use 224 and let VBLANK last for $\mathtt{262 - 224 = 38}$ lines. They used 384 dots per line out of 512 total leaving $\mathtt{512 - 384 = 128}$ dots to HBLANK. Developers can count on a resolution of \icode{384x224}.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrrrr} 
  \textbf{ } & \textbf{CP-System} & \textbf{Genesis (H40)} & \textbf{Neo-Geo} & \textbf{Super NES} \\
  \toprule    
   \textbf{Usable dots} & \texttt{384}  & \texttt{320} & \texttt{320} & \texttt{256} \\
   \textbf{HBLANK (dots )} & \texttt{128}  & \texttt{100} & \texttt{64} & \texttt{85}  \\
   \textbf{Usable lines} & \texttt{224} & \texttt{224} & \texttt{224} & \texttt{224} \\
   \textbf{VBLANK (lines)} & \texttt{38}  & \texttt{38} & \texttt{40} & \texttt{38}  \\
\toprule    

\end{tabularx}%
}\caption*{Usable resolution for CP-System and contemporaries}
\end{figure}

\pagebreak


\subsubsection{Pixel Aspect Ratio}

The scanlines of a CRT have a fixed height but the width of the dots vary from machine to machine because of their dot-clock. The width/height dot ratio is called the Pixel Aspect Ratio (PAR).

An "ideal" system would have "square" dots with a 1:1 PAR. For these "TV" CRTs built with a set physical scanline height, square pixels were guaranteed if the dot clock was 6,136,363 Hz ($\frac{135}{22}$). A system using a higher frequency would draw narrower dots while a system using a lower frequency would draw wider dots.

\begin{figure}[H]
\nbdraw{par}
\caption*{Pixel Aspect Ratio of four systems (exaggerated)}
\end{figure}


Let's look first at the Neo-Geo which has a PAR close to 1:1, resulting in square pixels\cite{par}.

\vfill
\begin{figure}[H]
\img{metalslug.png}
\caption*{Metal Slug as stored in the Neo-Geo ROM, SAR = 320:224}
\end{figure}


The PAR formula is a simple multiplication by a fraction.

\begin{align*}
 \mathtt{PAR = \dfrac{dotclock\;MHz}{\frac{135}{22}} = \dfrac{dotclock\;MHz * 22}{135}}
\end{align*}

The Neo-Geo MVS, with its dot-clock of 6,000,000 Hz has a PAR of 45:44. Combining its \icode{320x240} Storage Aspect Ratio (SAR) with its PAR gives the Display Aspect Ratio (DAR) of the physical image seen on the CRT.

\begin{align*}
 \mathtt{Display\;Aspect\;Ratio\;(DAR) = PAR * SAR = \frac{45*320}{44*224} = 1.46}
\end{align*}

The near-square pixels result in minimal distortion when the image is presented on a 4:3 CRT. This is very convenient for artists since they can digitize their assets 1:1 and see their artwork rendered as intended.

\vfill
\begin{figure}[H]
\img{metalslug_4_3.png}
\caption*{Metal Slug as it appears on a CRT, DAR = 1.46}
\end{figure}





The CPS-1 with its resolution of \icode{384x224} and its dot-clock of 8,000,000 Hz results in a PAR of 135:176. Its DAR somewhat matches the CRT aspect ratio of 4:3 ( = 1.333). 

\begin{align*}
 \mathtt{Display\;Aspect\;Ratio = PAR * SAR = \frac{135*384}{176*224} = 1.31}
\end{align*}

However its narrow pixels generate a significant amount of distortion, which was a huge problem for artists. If they digitized their drawings as is, the CRT would present to players a vertically-stretched version of the original vision. As illustrated on page \pageref{sf2_ratio}, an artist drawing a circular sun on paper, digitizing it as is, and running it via the CPS-1 would see an oval result on the screen.

Akiman reported the problem right away when he started working with the new platform.

\begin{q}{Akiman, Lead Artist\cite{akiman}}
When I was working on my first CPS-1 game, Forgotten Worlds, I noticed the problem of aspect ratio right away. 

- "The pixels are not square!" I told my boss.

- "Impossible, I ordered them to be square!" he replied.

He then proceeded to call hardware on the spot.

- "The pixels are square!" he added.

Later I protested again to which my boss replied it was a calculation error.
\end{q}

Could it has been an oversight? Could it actually been a calculation error? In all likelihood the hardware designers wanted to give the CPS-1 a very high horizontal resolution to make it competitive, even if this meant making artists' lives a little bit difficult.

Artists managed to work around this annoying "feature" by drawing their assets pre-stretched (as seen on \pageref{sf2_ratio_solution}). Their process is elaborated on page \pageref{artists_par}.
 
In the rest of the book, the format of images will vary. For real-estate reasons, the "screenshot" may be shown with SAR proportions or DAR proportions depending on the needs. The same goes with the drawings. Since the difference is pretty significant between squares and rectangles (as seen on page \pageref{sf2_ratio_solution}), aspect ratio is not mentioned again.

\pagebreak

\sbdraw{0.98}{sun}
\label{sf2_ratio}
\vfill
\sbdraw{0.98}{sun_4_3}

\pagebreak

\sbdraw{0.98}{sf2_intro}
\label{sf2_ratio_solution}

\sbdraw{0.98}{sf2_intro_4_3}





\begin{trivia}
\index{Games!R-Type}
The designers of R-Type at Irem were unsatisfied with the default "standard" 224 usable lines of a CRT. 

They calibrated their M72-System registers to draw 284 lines, 512 dots, and used an 8 Mhz dot-clock. Leaving 128 dots to HBLANK and 28 lines to VBLANK resulted in a resolution of \icode{384x256} which was higher than other arcade titles at the time. 

The trade-off was a vertical refresh rate of 55.017605 Hz which was visually less pleasing and dangerously 10\% off from the CRT recommended values. This refresh rate is difficult to replicate for "modern" emulators but what an impressive feat for a 1987 system!
\end{trivia}



\subsection{Color Space} \index{Colors!Space}
Before moving to the color generator, a characteristic to decide on was the color depth. 

The CPS-1 uses 16 bits to encode colors with 4 bits per RGB component for a total of 12 bits allowing 4,096 colors. 


\begin{figure}[H]
\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{clear_4bit.png}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{dark_4bit.png}
\end{minipage}
\caption*{CPS-1's 12-bit per color cube}
\end{figure}
  
The four remaining bits express brightness to allow 16 shades of a base color. In total, 65,536 different colors are available to artists.

\begin{figure}[H]
\nbdraw{brightness}
\caption*{All darker shades of red using a \icode{\{0xF,0x0, 0x0\}} base.}
\end{figure}

\subsection{Putting it all together}

Knowing how a CRT works and what decisions Capcom engineers made, we can now understand the video signal timings.

With a "pixel" clock coming from the GFX oscillator (16MHz) halved to 8MHz, a color is issued every 1s / 8MHz = 125ns.

The horizontal resolution of 512 mandates a HSYNC to be generated every 512 * 0.125 = 64$\mu$s. The resulting refresh rate is 8MHz / (512x262) = 59.637Hz and a VSYNC is issued every 1000ms/59.637 = 16.7ms.


A summary drawing exposes all timing and regions, as well as the significant part of the image not usable due to horizontal and vertical blanking.



\nbdraw{sf2_withoverscan_zero}



Keep in mind that HSYNC happens 262 times (green vertical lines) but VSYNC occurs only once. The dashed horizontal red line in the previous drawing is only here to represent where the electron gun resets to the top of the screen.

The sheer amount of black in the drawings shows the extent of the overhead associated with beam wobbling management. But the time spent not drawing is not wasted. It is leveraged to perform background operations such as modifying palette colors. e.g: Sixteen lines are necessary for a palette page (32 palettes) "upload".

\begin{figure}[H]
\nbdraw{sf2_withoverscan}
\caption*{Same concept but closer to what happen in CRT screen space}
\end{figure}


\subsection{Color generator}

To generate color signals, the CPS-1 uses a palette system storing colors via 4 x 2Ki x 1B \icode{CXK5814P-35L} SRAM chips.


These memory elements feature pinouts explained earlier like Power \icode{+5V}, Ground \icode{GND}, Addresses \icode{A0-A10}, Data \icode{D0-D7}, Write (\icode{WE}), Read (\icode{OW}), and Chip Enabled (\icode{CE}).

What is uncanny is that the component connected to the address lines is not the one connected to the data lines.
 % Instead data is routed towards a DAC.

\sdraw{0.45}{CXK5814P-35L} 




The CPS-B drives the address bus at 8MHz to generate the DAC 16-bit inputs, which in turn generates three analog Red, Green, and Blue signals. In parallel, it generates the HSYNC and VSYNC signals, composited into CSYNC.

Notice how one line out of twelve is used not for addressing but for \icode{CE}ing chip pairs. 




\nbdraw{video_lookup}




Colors are grouped into palettes containing 16 units. As will be studied later, the GFX system features 6 layers and each of them allows 32 palettes (called page). This brings the total to 6*32*15 = 2,880 colors which requires 12-bit to be indexed.

 The palette SRAM chips are nearly constantly used to generate colors. Their content can only modified during VBLANK.

\pagebreak




Twelves palettes from the characters of a famous Capcom fighting game. Can you recognize them?

\nbdraw{palette_ryu}

\nbdraw{palette_ken}

\nbdraw{palette_chun}

\nbdraw{palette_honda}

\nbdraw{palette_guile}

\nbdraw{palette_zan}

\nbdraw{palette_blanka}

\nbdraw{palette_dahlsim}

\par\noindent\rule{\textwidth}{0.5pt}

\nbdraw{palette_boxer}

\nbdraw{palette_vega}

\nbdraw{palette_sagat}

\nbdraw{palette_bison}

Hint: RKCHGZBD-BVSB.














\section{Graphic system}\index{Systems!Graphics}

The graphic system is the most complicated to understand in the whole machine. It is complex because it must satisfy three demanding systems.



On one side, there is Control which requests an elaborate composition of backgrounds and sprites to appear on the screen. The description is much more verbose than a simple integer received by the Sound system to play a sample or a music. Communication happens by not only exposing the graphic registers, but also sharing access to a shared memory called "GFX RAM". Control's m68k writes "draw commands" which the GFX system reads and executes.

On the other side is the 8 MHz Video system which mercilessly demands a pixel color every 125ns. The CRT cannons never wait and a color must be issued on the dot, no matter what. 

Finally there is the GFXROM, a huge repository of up to 12MiB graphic assets. It has a finite latency and throughput which cannot satisfy the Video systems if it were to work on a per-pixel request/response.

Solving these problems of timing and latency well is what made the CPS-1 stand out. It is inarguably the "secret sauce" of the system. 

\begin{figure}[H]
\sdraw{0.7}{ppus}
\caption*{Architecture of the CPS-1 Graphic System}
\end{figure}


\subsection{CPS-A and CPS-B: The ASICs powerhouse}\index{Processors!CPS-A}\index{Processors!CPS-B}
To build their rendering pipeline, Capcom did not rely on another company's product. They crafted their own \textbf{A}pplication-\textbf{S}pecific \textbf{I}ntegrated \textbf{C}ircuit (ASIC), tailored to their needs, the CPS-A (the brain) and CPS-B (the legs).





\subsection{Pens and Inks}
The elementary unit of work is a 4-bit value which is an index into a 16 colors palette. Everything, from backgrounds to sprites, uses these 4-bit nibble indexes. A good analogy, and the terminology used in this book, is to picture the GFX manipulating "pens" (palette indexes). The color to appear on the screen is decided not by the pen but by the value at this index, which is called "ink".

This division makes the GFX system unaware of the color that will appear to players on the CRT since it only manipulates pens.




Groups of four bytes encoding 8 pens are "tile lines". When combined vertically, they make a "tile", the elementary unit manipulated by background and sprite layers.

\nbdraw{gfx_format}

 \begin{trivia}
 Pen value \icode{0xF} is always treated as transparent!
 \end{trivia}



\subsection{Elements of drawing}

Games are made of backgrounds on top of which are drawn sprites. The easiest to implement are the background circuits. They are studied first, followed by the sprite circuits.

\subsection{Drawing background}

A background is described in terms of "tiles", whose arrangement is described in a map. The goal of the circuit is to "rasterize" the map of tiles (called "tilemap").

A naive design would work at the same speed as the video system (8MHz). For each pixel (every 125ns) the GFXRAM would be read to know what tile to display. Then a pen would be retrieved from the GFXROM. Finally that pen would be sent to the palette system where the color would be converted by the video DAC.

 \begin{figure}[H]%
 \nbimg{DL-0311.png}%
 \caption*{CPS-A die. Notice the real estate dedicated to GFXRAM caching}%
 \end{figure}%

 Even thought the machine uses the fastest type of memory (SRAM), its response time does not permit enough roundtrips. This problem is solved via caching, streaming, channeling, and a humongous (for the time) 32-bit GFXROM/CPS-B local data bus. 


\subsubsection{Caching}
The CPS-A only accesses the GFXRAM during the HBLANK interval. To eliminate memory read operations while a scanline is rasterized, a line's worth of tilemap is retrieved and stored in an internal cache of 256 entries. Each entry stores 16-bit  tileID + 10-bit attributes. Notice the two parts on the die storing respectively 10 bits and 16 bits.





\subsubsection{Streaming}
Pen values are streamed from GFXROM to the CRT without intermediate storage. The GFXROM data is retrieved eight pens at a time thanks to a 32-bit data bus.

The system works with the GFXROM address lines connected to the CPS-A (with intermediate PAL decoding). The data lines are connected to the CPS-B where pen values are selected/discarded before being sent to the video system.

 \begin{figure}[H]%
\sdraw{0.9}{gfx_groups}
 \end{figure}%


\subsubsection{Channels}
To further improve response time, the GFXROM data uses a layout where 8 consecutive bytes are interleaved 16 bits at a time across four chips. 

Upon reading, an address is issued to two chips at the same time, but their data lines are enabled consecutively. Channeling avoids one "fetch time" every two reads.

\nbdraw{channels}


\subsection{CPS1 Tilemaps}
The CPS-1 features three tilemap layers named SCROLL1, SCROLL2, and SCROLL3. They all rely on tilemaps made of 64x64 tiles.


\vfill
\begin{figure}[!b]
\img{color-00003208.png}
 \caption*{Street Fighter 2}%
 \end{figure}%
\pagebreak

SCROLL1 uses tiles of dimensions 8x8 resulting in a total dimension of 512x512. SCROLL2 uses tiles of dimensions 16x16 resulting in a total dimension of 1024x1024. SCROLL3 uses tiles of dimensions 32x32 resulting in a total dimension of 2048x2048.

\index{Colors!Palette page}
Each tilemap has a maximum capacity of 32 palettes (called a palette page) which any tile can use freely. SCROLLS can be offset ("scrolled", hence their name) by any X or Y value, appear in any order, and be used for any purpose.


In Street Fighter 2, three scrolls are used to improve parallax. The GUI elements are rendered alongside the sprites on a fourth layer called "OBJ" which is studied later.

Other titles such as the shoot'em up Forgotten Worlds required all the sprites the machine could provide for the gameplay. To avoid wasting any of them, the GUI is drawn on SCROLL1 instead of OBJ. The trade-off is that GUI elements are aligned on a 8-pixel grid which is a minor inconvenience.

Color codes used in this section are \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2, \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ.

\vfill
\begin{figure}[!b]
\img{rgb-00003208.png}
 \caption*{Street Fighter 2 layers}%
 \end{figure}%
\pagebreak


\subsubsection{Starfields}
Besides SCROLLs, the CPS-1 has two "STARfield" layers which are always behind the SCROLLs and always in order STAR1 then STAR2. Like the other layers, one full page of 32 palettes is available to each of them.

To render the stars, the GFXROM contains no tiles but instead bytecode dictating the position of points as well as palette cycling timing.

It is surprising nowadays to see so much silicon dedicated to a "niche" feature, but the extreme popularity of shoot
em ups like R-Type, Gradius, or Darius at the time made a good case for it. Designing a system saving both considerable GFXROM space and artists' time was a good idea at the time. Ironically, the platform ended up receiving no space shooter! 

That did not prevent the feature from being used, though. Long after STARfields went out of fashion, the system was re-purposed.




\vfill
\begin{figure}[!b]
\img{color_short_forgottn-00000450.png}
 \caption*{Forgotten Worlds. Notice the GUI elements grid alignment (SCROLL1)}%
 \end{figure}%
\pagebreak

\subsubsection{Noir Black}




When designers needed a full black background, instead of using a SCROLL and repeating requesting rows of black tiles to cover the whole screen, they only had to use a STARfield and request no stars. 

This is the unacknowledged poetry of the Street Fighter Hyper Fighting intro sequence. As the title appears, the black background is in fact a pitch black night sky which nobody ever knew about.

\begin{trivia}
The layer system does not use a painter algorithm where pixels are written over and over in a framebuffer. The CPS-B receives a stream of all layers' pens which are selected based on the layer priority and transparency value (\icode{0xF}). Once selected, the pen value is forwarded directly to the video system.
\end{trivia}


Layers color codes, \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2, \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3, \fcolorbox{black}{mycyan}{\vphantom{W}\hphantom{H}} STAR1, \fcolorbox{black}{myyellow}{\vphantom{W}\hphantom{H}} STAR2, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ.

\vfill
\begin{figure}[!b]
\img{rgb_short_forgottn-00000450.png}
 \caption*{Forgotten Worlds}%
 \end{figure}%
\pagebreak









\subsubsection{Draw order and Priority mask}\label{finalfight_trick}


The drawing order (also called "priority") of SCROLLs and the sprite layer are entirely configurable (excluding the STARs which must remain behind). Any order can be requested but there is an extra feature available to the SCROLL drawn just behind the sprite layer.

Take the example of Final Fight. After fighting their way to a busy subway, Haggar and Guy find themselves exiting the train station to continue happily brawling in a desolated part of the city. 

As they are going up the stairs, observe the "back to front" order the following layers.

- \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3 used for the skyline.\\
- \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2 used for the main playground.\\
- \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ for the main characters, tires, and barrel sprites.\\
- \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} On top of everything, SCROLL1 for the GUI.


\vfill
\begin{figure}[!b]
\img{ff_color-00007375.png}
 \caption*{Final Fight}%
 \end{figure}%
\pagebreak


It all makes sense except for one detail. If we look closely at Haggar (for those who never played Final Fight, Haggar is the bigger one of the two) something is off since it appears to be both in front and behind SCROLL2.

The CPS-B allows the SCROLL layer behind the OBJs to tag each of its tiles with a single priority group ID (from a choice of four groups). In each of these groups, sixteen bits indicate which pen in the tile palette have precedence over OBJ.

This is how Final Fight characters are sandwiched by SCROLL2. The tiles making the "near" portion of the ramp are tagged to use two priority mask groups. The "wood" tile use the group mask \icode{0} to make pens resulting in colors
\fcolorbox{black}{mask1}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask2}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask3}{\vphantom{W}\hphantom{H}} , and 
\fcolorbox{black}{mask4}{\vphantom{W}\hphantom{H}} being given precedence. 
Likewise, the garbage tiles are tagged with group \icode{1} to give precedence to eight pens resulting in colors 
\fcolorbox{black}{mask5}{\vphantom{W}\hphantom{H}}  , 
\fcolorbox{black}{mask6}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask7}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask8}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask9}{\vphantom{W}\hphantom{H}} ,
\fcolorbox{black}{maska}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{maskb}{\vphantom{W}\hphantom{H}} and  
\fcolorbox{black}{maskc}{\vphantom{W}\hphantom{H}}.

Once the exit animation is over, all tiles priority groups are cleared to allow free roaming (except behind the ramp) and brawling over the whole screen without priority concerns.

Refer to the CPS-B API on page \pageref{cpsbreg_programming} for more details about tagging and masking.
\vfill
\begin{figure}[!b]
\img{ff_rgb-00007375.png}
 \caption*{Final Fight with SCROLL2 layer grid}%
 \end{figure}%
\pagebreak

\subsubsection{Rowscrolling}
SCROLL 2 has the ability to horizontally offset rows based on their vertical position. 

This capability, commonly known as "rowscroll", is implemented via a table of 1024 10-bit integers (one for each line) in GFXRAM.

This is a feature completely hard-coded in the ASICs. Once requested, the m68k is uninvolved, it has no awareness of HSYNC, only VSYNC is known.

\begin{q}{Nin}
I knew we had raster scrolling so I talked with the programmers and we gave it a shot.  It was effective. However, to this day I have no idea about what's going on under the hood!
\end{q}

\vfill
\begin{figure}[!b]
\draw{ryu_rowscroll}
 \caption*{Street Fighter 2, Ryu's floor is rowscrolled}%
 \end{figure}%
\pagebreak

\subsubsection{Choosing features}

The starfield and rowscroll features are good examples of how difficult it is to design hardware. Doing it well consists of accurately predicting what will be useful and what won't. 

While starfields were heavily used in the inaugural title, "Forgotten Worlds", and prominently featured in the second one , "Strider", rowscrowll on the other hand saw no usage for nearly two years. 

Relegated to implementing flame effects in "Magic Sword" and hazy backgrounds in "Carrier Air Wing", rowscrolling barely appeared for a few seconds of gameplay in the five titles\cite{mame_cps1_video} it was featured in.

Ultimately, the balance of these two features was reversed when rowscroll was used to implement the notoriously beautiful per-line floor parallax in Street Fighter 2, massively contributing to the graphic appeal of the game.


\vfill
\begin{figure}[!b]
\draw{honda_rowscroll}
% color-00016530.png}
 \caption*{Street Fighter 2, Honda's level is triple rowscrolled}%
 \end{figure}%
\pagebreak







\subsubsection{Pushing the limits}

Besides priority mask, tiles can be flipped horizontally and/or vertically but there is no scaling or rotation. Moreover, the CPU has no access to the VRAM which forbids pixel "plotting". That did not prevent seemingly impossible effects from being achieved.



In Ghouls 'n Ghosts' first level, on top of hordes of zombies, a Red Arremer, and unforgiving controls, the player must face the weather. Wind picks up and soon after heavy rains. If you look at the screenshot of the layer below, most layers are used and no rain should be possible.

- \fcolorbox{black}{cyan}{\vphantom{W}\hphantom{H}} STAR1 used for the dark sky.\\
- \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3 used for background.\\
- \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2 used for playground.\\
- \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ for the main character, big rain drops, and enemies.\\
- \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} On top of everything, SCROLL1 for the GUI.\\



\vfill
\begin{figure}[!b]
\img{rgb_ghouls-00009167.png}
 \caption*{Ghouls 'n Ghosts with GUI}%
 \end{figure}%
\pagebreak

To add rainfall, developers leveraged temporal blending on the same layer as the GUI.\label{gg_rain} Every five frames the GUI is not drawn. Instead a full screen of rain tiles is rendered, resulting in a convincing effect. Temporal blending is often used to fake translucency. 

\subsubsection{Plotting pixels}

The introduction sequence of the shoot'em up Carrier Air Wing (page \pageref{caw_color} and \pageref{caw_rgb}) is even more impressive. As a F-14 Tomcat takes off from its carrier, the jet leaves in its trail an exhaust that expands vertically one pixel line at a time. The gaze then disperses with a fizzlefade effect. 

It seems like pixels are plotted into a framebuffer but both effects are rendered via the OBJ layer (\fcolorbox{black}{black}{\vphantom{W}\hphantom{H}}). Exhaust expansion is done with 16 pre-rendered tiles (each covering more vertical lines). The fizzlefade is achieved with titles featuring an increasing density of transparent pens. The fizzle repeating pattern is visible on the fourth color coded screenshot.


 

\vfill
\begin{figure}[!b]
\img{rgb_ghouls-00009168.png}
 \caption*{Ghouls 'n Ghosts when rain falls}%
 \end{figure}%
\pagebreak

\img{fizzlefade-0-color.png} \label{caw_color}

\img{fizzlefade-1-color.png}

\img{fizzlefade-2-color.png}

\img{fizzlefade-3-color.png}

\img{fizzlefade-4-color.png}

\pagebreak


\img{fizzlefade-0-rgb.png} \label{caw_rgb}

\img{fizzlefade-1-rgb.png}

\img{fizzlefade-2-rgb.png}

\img{fizzlefade-3-rgb.png}

\img{fizzlefade-4-rgb.png}

\pagebreak

\subsection{Drawing Sprites}
Drawing sprites is more difficult than drawing tilemaps. It involves solving the same problems of bandwidth and latency, only sprites can appear anywhere on the screen and are not aligned on a grid.

In order to fully appreciate how Capcom solved this problem, it is worth understanding how other platforms tackled it.

\subsubsection{Hardware sprites}
A sprite circuit can be implemented using the same logic as a tilemap. It is a special case where the map features a single tile and no  horizontal or vertical scrolling is allowed.

Every HSYNC, the GFXRAM is read to know if a sprite appears on the next scanline. If it does, the circuit makes sure to intercept tilemap pens to issue sprite pens instead. 

It is an approach that comes with two drawbacks. First, it requires one circuit per sprite which is expensive. Second, the one-to-one complexity makes it impossible to scale to more than a few units. Nonetheless, this is the solution used by machines such as the Commodore 64 which advertised their circuitry as "hardware sprites".\index{Sprites Multiplexing!C64}


As limiting as it sounds there is a bit of flexibility thanks to a technique known as multiplexing. A C64 has 8 sprite "units" but that does not mean it can only draw eight sprites on the whole screen. It only means it can only draw eight sprites on the same scanline.

As the CRT cannon progresses down the screen, a sprite unit used above can be reused to draw sprites located below. By changing the configuration during HBLANK, many more than eight sprites can be drawn. This trick was extensively used in games to reach well over 100 sprites on screen.


Likewise, by using built-in multiplexing, the Commodore Amiga placed an horizontal limit of 8 pixels for its sprites' width but allowed unlimited height.\index{Sprites Multiplexing!Amiga}

\subsubsection{Line buffer}
To scale better and increase the number of sprites supported, hardware designers introduced the concept of line buffers. 

A line buffer system requires a buffer as wide as a visible line on the CRT. The buffer is populated with pen codes by a Pixel Processing Unit. The number of sprites, scale and rotation capabilities depends on how much work the PPU is able to do. 

The limiting factor is that the line buffer can be written only during HBLANK (16$\mu$s) since it is used the rest of the time to feed the CRT.

Systems like the Super Nintendo use a line buffer with an impressive PPU resulting in breathtaking fullscreen visual effects involving Mode-7/HDMA. This particularly shone in games like F-Zero or Pilot Wings.








\subsubsection{Double Line buffer}
A straight forward way to make a GFX more powerful is to simply give it more time to do its jobs. The merciless pixel clock cannot be cheated but the pipeline can be made deeper.

By using two line buffers alternately, the GFX pipeline is made deeper which increases its latency but also frees itself from rendering only during HBLANK. While a line buffer is fed to the video, another one is rendered. This allows drawing during one full scanline (64$\mu$s) and a GFX four times more capable than one using a single line buffer. 

This choice, made by SNK for its Neo-Geo, allowed gorgeous titles such as "Metal Slug" to be built entirely with sprites without using tilemaps. 

This technique is so powerful that the entire Neo-Geo rendering pipeline revolves around its double line buffer system. It needs no tilemap system.


\subsubsection{CPS1 Sprite FrameBuffer}
Capcom engineers wanted something even more powerful than a double line buffer. To allow more time than the 64$\mu$s granted by a double line buffer, the CPS-1 was built around a double sprite framebuffer (the same technology as  Sega Super Scaler). To host these framebuffers, the machine uses a dedicated memory called VRAM.

With a double sprite framebuffer, the PPU does not just draw a line in advance but a whole screen. This technique averages 16\% more time per line for the graphic chip to do its work, and more importantly it allows any number of tiles per line (even the powerful Neo-Geo has a limit of 96 tiles per line).

The gain is massive but it comes with three drawbacks. 

\subsubsection{Price tag}
First, the price of the machine goes up since it requires much more buffering capacity. At the resolution of 384*224, 9 bits per pixel are stored (5-bit palette index + 4-bit color index) requiring 200 KiB of storage for two framebuffers.

\subsubsection{Bandwidth requirements}
The second impact is on the bus. A massive amount of data is now written and read to/from the VRAM. It requires so much bandwidth that an especially large data bus connecting the GFX pipeline and the VRAM must be designed.

\subsubsection{De-synchronization}
Lastly, there is the problem of tilemap and sprite synchronization. When the m68k writes a layout in the GFXRAM, the graphic system picks it up but routes background tiles and sprite tiles to different locations. The tilemap is rasterized directly towards the video system while the sprite layer is rendered to the VRAM framebuffer where it will be picked up on the next frame.
 

\begin{trivia}
The sync issue is particularly noticeable in Final Fight level 2. The subway wagon moves up and down to simulate rail junction bumps, but the handles on the ceiling and the characters appear to lag behind.
\end{trivia}

A three-frame sequence is enough to illustrate the issue. On frame 1, the scrolls of frame 1 are displayed. No sprites are visible at that point.

\begin{figure}[H]
\nbdraw{latency1}
 \caption*{Frame 1}%
 \end{figure}%

Next, the scrolls of frame 2 are displayed along with the spritebuffer from frame 1.
 

\begin{figure}[H]
\nbdraw{latency2}
 \caption*{Frame 2}%
 \end{figure}%

Finally, the scrolls of frame 3 are displayed along with the spritebuffer from frame 2. The desyncing can only be compensated in software by drawing OBJs one frame ahead of SCROLLs.

\begin{figure}[H]
\nbdraw{latency3}
 \caption*{Frame 3}%
 \end{figure}%





\subsubsection{CPS1 Sprites Tile}
With its architecture based on a double sprite framebuffer, Capcom built a powerful system able to move an immense volume of sprites. But performance was only one part of the equation. They also had to come up with a flexible way for artists to use it.

Up to that point, frustration arose from sprite dimensions (all sprites had to have the same sizes), shapes (mandatory rectangular), and colors (one palette per sprite). 

The CPS-1 lifted these three limitations by abandoning the concept of sprites. The CPS-1 does have a "sprite" layer but it is made of tiles of dimensions 16x16 pixels. Called OBJ (for OBJects) its TILEs can be arranged however an artist requires to build sprites of arbitrary shapes and sizes. 

Like the other layers, OBJ palette page features 32 units which any tile can freely use.

\pagebreak

Street Fighter II demonstrates the power of the tile system. Combining them creates a universe of rich characters with specific shapes, giving them more personality.

\begin{minipage}[t]{0.453\linewidth}
  \sdraw{1.0}{chunLi}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.53\linewidth}
  \sdraw{1.0}{zanghief}
\end{minipage}


Chunli guard pose, 25 tiles (3,200 bytes). Zangief standing, 34 tiles (4,352 bytes). 

\begin{minipage}[t]{0.3\linewidth}
  \sdraw{1.0}{ryu}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.53\linewidth}
  \sdraw{1.0}{sagat}
\end{minipage}

Ryu victory pose, 29 tiles (3,712 bytes). Sagat Tiger Punch pose, 30 tiles (3,840 bytes). 



\sdraw{1.0}{kingpin}

The ultimate boss in "The Punisher", Kingpin, is a mountain of a man made of 69 tiles, which covers half the screen. This impressive feat came with minimal "wasted" pixels thanks to the usage of composed tiles.


Tiles in the OBJ layer have attributes allowing them to be rendered horizontally and/or vertically flipped. However there is still no support for rotation or scaling.

\begin{minipage}[t]{0.535\linewidth}
  \nbdraw{damnd}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.445\linewidth}
  \nbdraw{damnd2}
\end{minipage}

 When Final Fight's  mini-boss, Damned, does a back-flip in level 1, no rotation is performed. Two sets of tiles are used and X/Y flipped to generate two extra mirrored sets. The effect works with four poses, thanks to fast movements and players' brain interpolation.

\pagebreak

\subsection{OBJ Limitations}
The sprite system has a hard limit of 256 tiles per frame. This is not an arbitrary number since the constraint is dictated by how many tiles the system is able to read from the GFXROM and write to the VRAM during a full CRT raster scan (16.7ms).

Because OBJ tiles are the most versatile (they can be placed independently and anywhere on the screen), it was tempting to use them often.

Street Fighter II designers pushed the machine to the edge of its limits by using OBJ tiles not only for opponents, arena decoration, GUI, but also to embellish the background parallax effect. This led to problems when a sequel was in the making.

When Ken faces Ryu in Japan, nearly 200 tiles are used. If two of the biggest contestants, Honda and Zangief, were to face each other on this stage, the CPS-1 would be unable to render all OBJ tiles necessary. Such configuration was impossible in "Street Fighter 2" but became a feature of "Street Fighter 2: Champion Edition",  which allowed mirror opponents to face each other in any location.
\vfill
\img{lack_sprites_color.png}


\begin{q}{Nin}
We carefully planned SF2 so that the biggest character and the second biggest character could just barely fit on screen at the same time. 

But when mirror matches became possible in Champion Edition, that meant that we had to be able to display two copies of the biggest character on screen. 

We ended up having to remove background elements and such.
\end{q}

To remain within the OBJ budget, the "wind, forest, fire, mountain" ("\begin{CJK}{UTF8}{min}風林火山\end{CJK}") sign was removed. All other breakables (Ken's barrel, Guile's crate, and Dictator's statues) were allowed to remain.

\begin{trivia}
Decorations in Street Fighter 2 were the object of much consideration. The stone on the ground in Sagat's stage randomly moves at the beginning of each round so it cannot be used as a landmark by players.

\end{trivia}

\vfill
\img{lack_sprites_rgb.png}




\subsubsection{Going too far} \label{going_too_far}
Games were tested to ensure the OBJ budget was not exceed but Final Fight's last level (Bay Area) managed to ship with that very problem. When the heroes encounter an unprecedented level of opposition, the list of sprites is as follows\cite{ffoverload}.

\begin{itemize}[topsep=0pt]
\item Haggar and Cody.
\item Two standing barrels and two rolling barrels.
\item Three Axl (grey heavy) (two flying backward).
\item Three Slash (copper heavy) (two temporarily KOed).
\item One Bred (grey minion) and one Dug (red minion).
\item Dirt raised by the rolling barrels.
\end{itemize}

This scene has 258 tiles on the OBJ layer. Final Fight engine is smart enough to not render partial sprites. Since
Haggar, the last sprite on the list, pushes the total 2 tiles past the maximum, all its tiles are dropped.

\vfill
\img{ff_OBJ_overload.png}

\pagebreak

 
\nbdraw{ff_OBJ_overload_details}



\pagebreak


\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001209}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001210}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001211}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001212}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001213}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001214}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001215}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001216}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001217}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001218}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001219}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001220}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001221}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001222}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001223}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001224}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001225}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001226}
\end{minipage}


\pagebreak









\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001227}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001228}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001229}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001230}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001231}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001232}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001233}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001234}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001235}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001236}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001237}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001238}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001239}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001240}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001241}
\end{minipage}

The lack of OBJ scaling and rotation was a problem for developers of Street Fighter 2 as the intro needed precisely these two operations. 

To fake it, two logos are used, a small one made of 33 tiles and a large one made of 112 tiles. Tiles move on a circular pattern revolving around the center of the shape. The small to large substitution happens at the end of the first revolution.

Once again, Capcom banked on fast movement, brain interpolation, and maybe forgiveness due to a damn good game.












\subsubsection{The World Warrier}
The OBJ system was used in a creative way by Akiman to solve a show-stopper bug when he was working as a planner for Street Fighter 2.

\begin{q}{Akiman}
Just three days before the deadline, I discovered something horrible. 

I had made a mistake with the subtitle “World Warrior”, mis-spelling it “World Warrier.”
\end{q}

The subtitle was drawn with the OBJ layer, using 16 draw calls pointing to tileID \icode{0x0}, \icode{0x1}, \icode{0x2}, \icode{0x3}, \icode{0x4}, \icode{0x5}, \icode{0x6}, \icode{0x7}, \icode{0x8}, \icode{0x9}, \icode{0xA}, \icode{0xB}, \icode{0xC}, \icode{0xD}, \icode{0xE}, \icode{0xE}. 

Looking inside the GFXROM, one can find the 16 tiles making the "World Warrier". 

\begin{figure}[H]
\nbdraw{worldwarrier_tile}
 \caption*{The 16 OBJ tiles making the title, with a typo}%
 \end{figure}%

\begin{q}{Akiman}
It was several months after all the sprite work had been done. Since the logo had already been created, I couldn't just go in and change the letter at this point.
\end{q}

What Akiman describe is that the GFXROM and all the tiles in it had been finalized. However they could still make modification to the 68000 instructions and most importantly, the palettes that were stored along with it.

\begin{q}{Akiman}
"Maybe I can just force it to look like an ‘o’," I thought. I tried layering various other sprites over it until finally, it looked like an ‘o’. 

Phew!
\end{q}

\begin{figure}[H]
\img{sf2_title_warrier.png}
 \caption*{A recreation of the problem}%
 \end{figure}%



How in the wORld, do you make an 'e' looks like an 'o'? It turns out that Akiman was lucky in the mistake he had made since the letters he needed, 'o' and 'r', can be found in the word "World".

Akiman leveraged what was available and changed the 68000 draw calls to drop the three last tiles and instead draw again tiles \icode{0x6} and \icode{0x7} at the end.

It only partially solved the problem since the split 'W' looked like an 'l' which made the title read "The World Warrlor". 

\begin{figure}[H]
\nbdraw{world_warrWor}
 \caption*{"The World Warrlor". A little bit better}%
 \end{figure}%


The problem was displaced from turning an 'e' into an 'o', to turning an 'l' into and 'i'. That would have been simple if the CPU could have written in the VRAM but as we have seen these chips are not mapped in the m68k address space.

There is an expensive way to fake pixel plotting. The idea is to find a tile almost fully transparent (\icode{0xF}) but with only a single pen value set in it. 

Akiman found just that in one of Guile's poses. His calf met these criteria with a simple pen value in its lower left.

\begin{figure}[H]
\nbdraw{guileCalve}
\caption*{Guile's calf saves the day}%
 \end{figure}%

Using Guile's calf as a pencil, but with the title's palette, three tiles are drawn over the 'l' to split it into an 'i'.

\begin{figure}[H]
\nbdraw{palette_guile}
 \caption*{Guile palette.}%
 \end{figure}%

 \begin{figure}[H]
\nbdraw{palette_title}
 \caption*{Title palette.}%
 \end{figure}%


 In an troubling coincidence, the pen corresponding colors were a match.

\begin{figure}[H]
\nbdraw{world_warrior_title}
 \caption*{18 draw calls. Three more than necessary but with proper spelling.}%
 \end{figure}%

\begin{figure}[H]
\img{sf2_title.png}
 \caption*{Once you see it, you can't unsee it}%
 \end{figure}%

% Sometimes, in order to ship, you need to be pragmatic.


\subsection{Putting it all together}

We now have enough knowledge to fully understand how the CPS-A and CPS-B cooperate to render graphics.

The two graphics chips closely work together by sharing custody of the GFX ROM and VRAM. 


 The CPS-A generates four interleaved stream of pens (OBJ, SCR1, SR2, and SRC3) by driving the address bus.
  The CPS-B receives the data and decides for each "pixel" which stream is visible. 


\begin{figure}[H]
\nbdraw{shared_custody}
\caption*{CPS-A (address) and CPS-B (data) GFX ROM/VRAM lines}
\end{figure}

Besides deciding source and destination of data, the CPS-A also generates LI: (Line increment) and FI: (Frame increment) towards the CPS-B where they are turned into HSYNC and VSYNC for the CRT.

The 23-bit address line to the GFX ROM is special. It is not a raw address but a layerID + tileID within that layer. The PAL \icode{STF29} converts IDs into addresses.


The CPS-B is put under heavy contribution. It must simultaneously write the next sprite framebuffer but also render the current by reading the previous sprite framebuffer and sampling all five other layers.

\nbdraw{vram_rw}

To keep up with bandwidth requirements, the VRAM and GFX ROM systems are specifically crafted with wide data lines.








\subsubsection{VRAM}
The VRAM system is physically split via two independent blocks, A and B, to facilitate sprite buffer double buffering. This component also benefits from an exceptionally powerful chip compared to the rest of the machine.

A quick glance at the \icode{HM53461P} shows the usual \icode{+5V}, \icode{GND}, \icode{CLK}, and address/data pins. However \icode{SD0}, \icode{SD1}, \icode{SD2}, and \icode{SD3} indicate this chip does more than the ones we have seen so far.

\sdraw{0.55}{HM53461P-10}

Able to store 65,536 Ki x 4-bit, the \icode{HM53461P} is peculiar because it not only features a RAM port (\icode{D1-D4}), it also features a SAM "serial" port (\icode{SD1-SD4}).
 
The RAM port is accessed "normally" by first asserting the address lines along with the control lines and then reading or writing on the data lines.

The SAM port is different. Upon asserting the address lines, an internal buffer is latched. Each subsequent control operation automatically increments the address counter.

This design would allow RAM and SAM to be accessed simultaneously but this never happens. When A is read, B is written and the other way around. The real value is in the access time. If the RAM port's 100ms is a "normal" figure, the SAM port read operations complete more than twice as fast, taking only 40ms. 

 This is a perfect component for a system that needs to write a few values at varying locations (like when the CPS-B renders a sprite buffer) but read a very large amount sequentially (like when the CPS-B must compose pens towards the palette system).

 On the Street Fighter II board, twelve \icode{HM53461P} are combined into six pairs, resulting in 384 KiB. Four chips are used for a single line so 96 KiB is never used.

\nbdraw{vram}


% \red{Why so much VRAM? You only need two framebuffer with palette data but there is almost 150 KiB too much there. Could it have been a provision for future improvements?}


% \begin{trivia}
% All memory systems are built with either ROM or SRAM. The VRAM system is the only one built with DRAM and therefore has a memory refresh mechanism.
% \end{trivia}


\subsubsection{GFX ROM}
To keep up with the much higher storage requirements, the GFX ROM system is not designed like the others. 

While other chips on the board-B are \icode{27C010} and \icode{27C512}, the GFXROM is made of \icode{MB834200B} (256 Ki x 16-bit). This type of ROM has a much higher capacity but also a slower access time (150ns). 

It is likely the dual-channel architecture is the result of a combined desire to use inexpensive components to keep the price down while maintaining high performance.


\sdraw{0.7}{MB834200B-15}

On the Street Fighter II board, twelve \icode{ MB834200B-15} are combined for a total of 6 MiB of GFX assets.

\nbdraw{gfxroms}

% TODO: Talk about channel and how it helped to improve performances of the GFXROM. 

\section{Copy protection system}

Upon release, Capcom CEO Kenzo Tsujimoto was confident the CPS-1 would significantly reduce piracy, even going as far as labeling it "impossible to copy".

\begin{q}{Kenzo Tsujimoto, Capcom CEO\cite{gamest38}}
    
The new CP System arcade boards are very important to Capcom in two regards. First, they have much more memory than our previous hardware. Game developers will have free reign to explore new, exciting design ideas and take advantage of the latest technological developments. The CP System has upped the level of our developers already.

The second big thing is copy protection. Illegal bootlegs have been a huge problem for us overseas; I believe the CP System is the only PCB hardware today that cannot be copied. The boards contain various copy protection methods, and their advanced hardware should make it difficult for bootleggers seeking to create knockoffs with today's components. 

Bootlegs don't only hurt us; they're also a nuisance for our customers who think they are getting a genuine board. We see copy protection as one of the main achievements of the CP System.
\end{q}


There were good reasons to be optimistic. Engineers had crammed the platform with protections to prevent two types of piracy.


\textbf{Hardware piracy} means selling physical copies of PCBs (called bootlegs). By dumping the ROMs' content from a legitimate board and buying the same off-the-shelf components, pirates sold the same game for cheaper.

The CPS-1's answer was to use custom components that would not be readily available for purchase, thus preventing counterfeiters from replicating a PCB. Capcom had Ricoh exclusively fabricate the two custom ASICs, the CPS-A, and CPS-B. To protect against decapping and reverse-engineering, metal grids were layered on top of the ASICs\cite{arcadeHackerCPS1Rev}. 


\textbf{Software piracy} involved operators purchasing an authentic game to get the PCBs but then copying ROMs to get newer games for free. 

Capcom's response was a two-way verification. The hardware could be actively used by the software to check the board's authenticity, backed by "passive" mechanisms that allowed the hardware to check the software behavior.

\begin{figure}[H]
\nbimg{copy_protection.png}
\caption*{Capcom's disclaimer when a CPS-1 game boots}
\end{figure}

\subsection{The ever changing CPS-B}
The heart of the protection system is the CPS-B. The core idea is to make it behave differently depending on the game it is supposed to run.

To this effect, twenty-five versions the CPS-B exist\cite{mame_cps1_video}, sometimes differing between revision of the same game\cite{cpsBNumbers}.


\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrrr} 
  \textbf{Game Name} & \textbf{Revision} & \textbf{ CPS-B }  & \textbf{ Year } \\               
  \toprule    
\href{}{Forgotten Worlds} & & \texttt{CPS-B-01} & 1988 \\ 
\href{}{Lost Worlds} & & \texttt{CPS-B-01} & 1988 \\ 
\href{}{Ghouls'n Ghosts} & & \texttt{CPS-B-01} & 1988 \\ 
  \toprule    
\href{}{Strider} & & \texttt{CPS-B-01} & 1989 \\ 
\href{}{Dynasty Wars} & & \texttt{CPS-B-02} & 1989 \\ 
\href{}{Willow} & & \texttt{CPS-B-03} & 1989 \\ 
\href{}{U.N Squadron} & & \texttt{CPS-B-11}   & 1989 \\ 

\href{}{Final Fight } & \texttt{Original} & \texttt{CPS-B-04} & 1989 \\ %ffight
\href{}{Final Fight } & \texttt{900112}& \texttt{CPS-B-01} & 1989 \\ %ffightua
\href{}{Final Fight } & \texttt{900424}& \texttt{CPS-B-03} & 1989 \\ %ffightub
\href{}{Final Fight } & \texttt{900613}& \texttt{CPS-B-05} & 1989 \\ %ffightuc

  \toprule    
\href{}{1941: Counter Attack} & & \texttt{CPS-B-05} &  1990 \\ 
\href{}{Mercs} & &  \texttt{CPS-B-12} & 1990 \\ 
\href{}{Mega Twins} & & \texttt{CPS-B-14} & 1990 \\ 
\href{}{Magic Sword} & & \texttt{CPS-B-13} & 1990 \\ 
\href{}{Carrier Air Wing} & & \texttt{CPS-B-16}  & 1990 \\ 
\href{}{Nemo} & & \texttt{CPS-B-15} &  1990 \\ 
  \toprule    
\href{}{Street Fighter II: The World Warrior }&  \texttt{Original}& \texttt{CPS-B-11} & 1991 \\  %sf2
\href{}{Street Fighter II: The World Warrior } & \texttt{910204}& \texttt{CPS-B-17} & 1991 \\  %sf2ea
\href{}{Street Fighter II: The World Warrior } & \texttt{910318}& \texttt{CPS-B-05} & 1991 \\  %sf2ed
\href{}{Street Fighter II: The World Warrior } & \texttt{910228}& \texttt{CPS-B-18} & 1991 \\  %sf2ee
\href{}{Street Fighter II: The World Warrior } & \texttt{910411}& \texttt{CPS-B-15} & 1991 \\  %sf2ef
\toprule    
\end{tabularx}%
}\caption*{A selection of the many Capcom CPS-1 game revisions}
\end{figure}

In the early days of the CP-System, the CPS-B chips changed frequently. The table above only contains a few of the many PCB revisions. There is a correlation between the number of revisions and how successful a game was. Street Fighter 2 was revised 34 times, while Final Fight received 13 "refreshes".

With the release of "Three Wonders", Capcom stopped changing the CPS-B in favor of a better protection system. All CPS-B ASICs onward were CPS-B v21.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrr} 
  \textbf{Game Name} & \textbf{ CPS-B }  & \textbf{ Year } \\               
  \toprule    
\href{}{Three Wonders} &  \texttt{CPS-B-21} & 1991 \\ 
\href{}{The King of Dragons} &  \texttt{CPS-B-21} &1991 \\ 
\href{}{Captain Commando} &  \texttt{CPS-B-21} & 1991 \\ 
\href{}{Knights of the Round} &  \texttt{CPS-B-21} &1991 \\ 
  \toprule    
\href{}{Street Fighter II: Champion Edition} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Adventure Quiz: Capcom World 2} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Varth: Operation Thunderstorm} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Quiz \& Dragons: Capcom Quiz Game} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Street Fighter II' Turbo: Hyper Fighting} &  \texttt{CPS-B-21} & 1992 \\ 
  \toprule    
\href{}{Ken Sei Mogura: Street Fighter II} &  \texttt{CPS-B-21} &1993 \\ 
\href{}{Pnickies} &  \texttt{CPS-B-21} &1993 \\ 
  \toprule    
\href{}{Quiz Tonosama no Yabo 2} &  \texttt{CPS-B-21} & 1995 \\ 
\href{}{Pang! 3} & \texttt{CPS-B-21}  & 1995 \\ 
Mega Man the Power Battle & \texttt{CPS-B-21}  & 1995 \\

\toprule    
\end{tabularx}%
}\caption*{After 1991, all CPS-1 games used CPS-B v21}
\end{figure}


\subsection{ID check}
The simplest copy protection available is the chip ID check. By polling a register, the m68k prompts the CPS-B to return its version number. A version match lets the code know if its belongs to the right PCB and resets the CPU if it doesn't. 

To make instructions patching of the 68000 ROMs more difficult, calls to verify the chip ID are placed in several locations in the code. Motivated programmers tried anyway\cite{strider_conversion}!

\subsection{Multiplication check}
Starting with CPS-B v21, a slightly more robust feature gave the CPS-B the ability to perform multiplications. Two registers are written and a third can be read. The 68000 code checks that the returned multiplication result is the expected value.

\subsection{Moving registers}
The CPS-B registers move between revisions. The offset and range does not change, but the offset of each register inside that mapping is different. Accessing the scroll control, scroll priority, and palette upload registers is done slightly differently for each game.

Additionally, the meaning of each bit field inside each register is altered between versions.



\subsection{Unexpected behavior detection}
Protections described so far involved active software and passive hardware. The hardware can also actively monitor the software by leveraging the moving register policy. If the CPS-B detects incoherent values written to the wrong registers, it sets and locks all palettes of all layers to black. 

The game still runs in the background and the audio is played but the screen doesn't display anything. The only way to recover is to reboot the machine\cite{petitSecurity}... only for the screen to turn black again.






\subsection{Invalid offset detection}

Each game uses a different amount of assets for each of its SCROLL and OBJ layers. On the "B" board, PAL chips such as the \icode{STF29} discussed earlier are hard-coded with knowledge of the amount of GFX ROM attributed to each layers.

Tile references pointing beyond a range are ignored resulting in rendering "holes" if a game ROMs are inserted in a non-matching "B" board.

\begin{q}{Mame cps-1 video driver}
All graphics are
stored together in the same ROMs.

But the hardware knows which part of the ROM space
is 8x8 tiles, 16x16 tiles, 16x16 spites, 32x32 tiles, and all games tested only
draw tiles if their code falls in the valid range. 

If a tile is out of range, it is replaced by transparent pixels.
\end{q}

\begin{trivia}
Pull-up resistors on the board along the GFX ROM data lines detect if a pen value matches a tileID. 

If no data is detected, \icode{0xF} is automatically "inserted", resulting in a transparent value.
\end{trivia}



\subsection{Configuration Key}
Up to 1991, the behavior of a CPS-B was hard-coded in its silicon at the factory level. There was no way to alter or re-purpose them after they shipped. 

It was not only expensive to have to revise the hardware circuits for each game, it was also a logistic difficulty to provision enough chips for a success and not be stuck with inventory on an unappreciated game. To solve this issue, Capcom revised the CPS-B chip one last time and made it configurable via software.

The whole behavior is encoded in a small internal 18 byte area using not ROM but RAM. To keep these bytes alive, the CPS-B v21 must be supplied with current at all times\cite{petitSecurity}.

The configuration RAM was designed to survive when the cabinet was turned off thanks to a battery located  on the soldering side of Board C and connected to the CPS-B. The chip was even designed to survive having no battery for a few minutes to allow battery replacement.

\begin{trivia}
These batteries worked remarkably well since, thirty years later, one can find boards in working condition still using their original battery.
\end{trivia}

\subsubsection{Suicide batteries}
The infamous "suicide" nickname came from the effect of losing power. A CPS-B v21 without power lose its configuration and resets all its registers to "default" values that none of the games use. Capcom offered a battery replacement service to resurrect boards "C" which had committed seppuku but eventually discontinued it. 

As the reader will have guessed, passionate fans found a way to bring these games back to life.

\subsubsection{Phoenixing}
The first method is called "phoenix"-ing. It is a tedious process which consists of dumping a game ROM and patching the m68k instructions to replace CPS-B registers accesses to use the "default values"\cite{csp1_phoenix}. 

People phoenixing CPS-1 boards have such intimate knowledge of the CP-System that they even changed the game to display a "Phoenix Edition" splash upon startup.

\begin{figure}[H]
\nbimg{phoenix_screen.png}
\caption*{A phoenixed game boot splash screen}
\end{figure}


\subsubsection{De-suiciding}
Eventually, passionate people figured out the process of accessing and writing the CPS-B RAM. Boards can be brought back to life by re-uploading the proper configuration bytes which essentially de-suicides them\cite{arcadeHackerCPS1Desuicide}.







\section{Epilogue}
From 1988 to 1995, Capcom used the CPS-1 to release more than thirty titles. These seven years saw the birth of three of Capcom's most loved franchises: Ghouls’n Ghosts, Final Fight, and Street Fighter 2.

To Capcom, the CPS-1 was a gamble that paid off hundredfold, allowing them to become a video game household name. 

To players, the games were a series of beautifully crafted titles which both provided entertainment and emptied their pockets. The experience was so memorable that passionate people wrote emulators and even (in some extreme cases of obsession) books to keep these memories alive. 

To counterfeiters, the CP-System was a problem. Capcom games were popular and generated a substantial amount of money. It is likely greed set in even more so once demand skyrocketed with the advent of AAA titles such as Street Fighter II. 

Capcom engineers had designed security measures able to discourage attackers with a reasonable amount of determination. Perhaps the one flaw the CPS-1 can be faulted with is that it did not provision for the unprecedented level of popularity it enjoyed.

The money in the balance armed the counterfeiters with an unreasonable amount of tenacity. As players lined up to spend time and beat Street Fighter 2, so did the pirates to defeat the copy-protection systems. Eventually they were able to figure it out. 


Of all the security measures, it would have been fair to assume the custom ASICs would be an impenetrable fortress. Astonishingly, CPS-A and CPS-B replicas were manufactured under the name "COMCO"\cite{arcadeHackerCPS1}. It is unknown if an insider leaked the schematics or if someone made it their life mission to reverse-engineer these chips to make it happen but it did.

As cracks appeared in its shield, Capcom did not give up on protecting its titles. As it had proved itself able to evolve and compete in the business of producing games, it embraced the challenge of embarking on an encryption crusade against bootleggers.

\subsection{CPS-1.5 Kabuki}
\index{CP-System!CPS-1.5 Kabuki}
In 1992, Capcom released the CP System Dash (a.k.a CPS-1.5). Fully encased in a gray plastic box, it introduced a fourth satellite "Qboard" PCB to handle playback of positional three-dimensional Qsound audio. Five games were produced until late 1993.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrr}
  \toprule    
  \textbf{Game Name} & \textbf{ GFX }  & \textbf{ Year } \\               
  \toprule    
\href{}{Cadillacs and Dinosaurs} & 4 MiB & 1992 \\ 
\href{}{Warriors of Fate} & 4 MiB & 1992 \\ 
\href{}{The Punisher} & 4 MiB & 1993 \\ 
\href{}{Saturday Night Slam Masters} & 6 MiB & 1993 \\ 
\href{}{Muscle Bomber Duo: Ultimate Team Battle} & 6 MiB & 1993 \\ 
  \toprule    
\end{tabularx}%
}\caption*{Capcom CPS-1.5 based arcades games}
\end{figure}

\label{kabuki}
The CPS 1.5 is noteworthy for its improved copy-protection. Audio instructions are stored encrypted in the ROM. The audio CPU is a special z80 dubbed Kabuki\cite{arcadeHackerKabuki} able to decrypt instructions on the fly.

The encryption scheme is symmetric. A secret key is used to encrypt the ROM when it is built, and the same secret key must be used to decrypt it at runtime.

The key is not burned in the z80's silicon but, like the CPS-B v21 configuration, stored in an internal RAM. To keep that key alive, the unused pin 28 we saw on page \pageref{z80_pinRFSH} is re-purposed from "DRAM refresh" to providing power. Like the CPS-B and its RAM configuration, the z80 requires power at all times which means the system was provided with a second "suicide battery". 





\begin{trivia}
The protection provided by Kabuki held remarkably well over the years. It was only broken in the early 2000s\cite{mame_kabuki}.
\end{trivia}

\subsection{CPS-2}
\index{CP-System!CPS-2}
With significantly improved capabilities thanks to its increased ROM capacity and higher processor clocks, the CPS-2 instantly became a smash-hit, in particular thanks to the Street Fighter Alpha series. 

From 1993 to 2003, forty-two games were published. The first one was the wildly successful "Super Street Fighter II" while the last one "Hyper Street Fighter II: The Anniversary Edition" paid homage to a series that defined the platform.

In terms of copy-protection, Capcom once again cranked up security. The platform featured not only the Kabuki audio instruction encryption scheme, but it also gained encrypted game logic. 

Thanks to a custom CPU, ABI compatible with the 68000, instructions are stored encrypted in ROM and decrypted on the fly. Like Kabuki, the scheme uses a shared secret key stored in yet another battery-powered RAM (the third one).

The only part of the CPS-2 that still stored plain instructions was the OKI ROM containing audio samples. The GFXROM data was not encrypted but its content was obfuscated via shuffling.

\begin{trivia}
No bootleg of CPS-2 titles were ever produced. Its protection system was remarkably strong and held for nearly 10 years. It was only when the "CPS-2 Shock Group" attacked it in 2003\cite{cps2rebirth} that its functioning was reverse engineered.
\end{trivia}



