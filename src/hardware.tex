\chapter{Hardware: CPS-1}

The project that would later be dubbed by the press "superchip"\cite{tgm198906} started between 1985 and 1986. It was a massive investment that would require two years and five millions dollars\cite{becareful} (the equivalent of \$12 millions dollars in 2022).

The significant time and funds investment left not ambiguities in the mind of Capcom executives. Success would be to dictate the life or death of the company.

\begin{q}{Yoshiki Okamoto, Capcom Producer\cite{gamest38}}
The CP-System is an extremely important business strategy to Capcom: we have gambled everything on it.
\end{q}

\section{Goals}
The CPS-1 was expected to solve most of Capcom arcade division problems. Namely reduce production cost, lower selling price, streamline development, increase capabilities, and stop piracy. 

Cost reduction would be achieved by mimicking home consoles and standardizing the platform. Instead of re-designing boards for each games, the hardware would be a constant with the cabinet differentiated only by the software running on it.

Price lowering would allow arcades operators to renew their games more often. This objective would be reached by designing a platform where new games board containing mostly ROMs could be purchased separately from the processor board therefore facilitating upgrades.

The development toolchain would improve thanks to the stability of the target platform. Without having to constantly rewrite parts, Capcom could invest in the long term and build an SDK running on powerful workstations such as SHARP's series of X68000s.

More importantly, games would had to catch customer eyes and not pale in comparison with competition. The goal was to design a machine with graphic capabilities an order of magnitude above others and generate visuals that would hold they own when compared to titles from powerhouse such as Sega or Namco.

Most importantly was the problem of piracy. In a country like Mexico it was estimated that 200,000 bootlegs were in circulation\cite{sf2_oral_history} despite Capcom recording zero sales in that territory. Multiple concurrent copy-protection mechanisms were to be implemented.



\section{JAMMA}



\begin{wrapfigure}[19]{r}{0.3\textwidth}
\vspace{-\baselineskip}
\centering
  \sdraw{0.3}{cabinet}
\end{wrapfigure}


% \begingroup
Operators frequently updated their cabinets by replacing the game it ran in order to keep on bringing novelty to players and quarters to themselves. Thanks to the Japan Amusement Machine and Marketing Association, the process of changing titles was simple. 

Usually hiding an abomination of tangled wires the belly of the machines concentrated toward a JAMMA harness where the motherboard would be inserted as a slot-in. All an operator had to do was to swap PCBs.

A JAMMA port has everything a game needs to operate. Its 28 pins on each sides provide inputs (four-direction joystick and three buttons per player, two coin sensors, start button, and service button), outputs (mono speakers lines and "monitor" controls), and even power supply.

The problem with such a standard is that if it improves interoperability, it also hinders innovation. 

A few pins on the port are not reserved for a specific usage but they could not be used for extra features since once the harness was wired, operators did not want to touch it.



 \begin{figure}[H]
\draw{jamma_t}
\caption*{JAMMA parts side pins}
\end{figure}

 \begin{figure}[H]
\draw{jamma_b}
\caption*{JAMMA bottom side pins}
\end{figure}



When Capcom had to retrofit Street Fighter 1 pneumatic buttons, they chose to do it with six buttons per player which was three more than are available in JAMMA. To circumvent the limitation, they designed a parallel input system. 

Since the three JAMMA buttons were used for punches, the extension was labeled the "kick harness".

\begin{figure}[H]

\begin{tabularx}{\textwidth}{lrX}
  \toprule    
  \textbf{Wire Color } & \textbf{ Pin \#}  & \textbf{Function } \\               
  \toprule   
  Black & 1 & GND \\
  Black & 2 & GND \\
  \toprule   
  Purple & 3 & Player 1 Light Kick \\
  Grey & 4 & Player 1 Medium Kick \\
  White & 5 & Player 1 Heavy Kick \\
  \toprule   
  & 6 & NC \\
  \toprule   
  Orange & 7 & Player 2 Light Kick\\
  Green & 8 & Player 2 Medium Kick\\
  Blue & 9 & Player 2 Heavy Kick\\
  \toprule   
  & 10 & NC \\
  \toprule   
\end{tabularx}
\caption*{Kick harness pinouts}
\end{figure}










  


\section{Physical Architecture}
 The CPS-1 is made of three printed circuit boards named Board "A", Board "B", and Board "C" which are stacked on top of each others.


\begin{figure}[H]
\centering
\nbdraw{arch_phy}
% \caption*{A full CPS-1 game made of three PCBs}
\end{figure}

\pagebreak
The connection points are prominent white connectors. Boards A and B are connected via four 2x32-pins connectors while the boards B and C are connected with four 2x20-pin connectors.  Once plugged into each others, the boards are manipulated as a whole with no floating parts.


The system was revised over the years. Approximately 229 variations are known to exist, including bootlegs\cite{mame_cps1_video}. The board which will be studied in this book is the one used to run "Street Fighter 2", which uses board A "88617A-7B", board B "90629B", and board C "90628-C".

\subsection{Board A}\index{Board!Board A}
The board "A" is the platform that never changes between games. It features all but one of the chips in charge of processing data, whether it is game logic, audio, or video.

A summary look at page \pageref{fig:boarda} reveals the powerhouse of the whole system where even an untrained eye will notice the size of the Application-Specific Integrated Circuit (ASIC) and the shear number of bus lines leading to it. In the center left stands the "CPS-A", in charge of 50\% of the graphic system and its 16MHz oscillator. Just above is 384 KiB of VRAM to store a special kind of framebuffer studied in later pages.

Directly below the CPS-A is the video system and its 8 KiB of SRAM containing the palettes.

The upper right section is the control system with a Motorola 68000, a 10MHz oscillator, 64 KiB of "work" SRAM and 192KiB of GFX SRAM. 

The middle right part is where the audio system lives. It is made of a Zilog-80, a 3.58MHz oscillator, and 2 KiB of "work" SRAM. Also in this area are present the audio chips dedicated to music (YM2151 and YM3012) and sound effects (OKI6295).

Finally, in the bottom part we find all the components taking care of the inputs and outputs of the JAMMA connector. Alongside are three DIP switches which an arcade operator can use to configure game parameters such as difficulty or how many credits a coin grants.

There are many chips on these three boards but it would be a mistake to conclude that combining many processors inevitably leads to better performance. That would be ignoring issues such as bus congestion, bus size difference, bus timings or even processor endianness. 

To design an effective multi-CPUs system able to avoid both instructions and data starvation is in fact far from trivial.


\
  \simg{0.94}{88617A.png}
\label{fig:boarda}


  \sdraw{0.94}{88617A}
\label{fig:drawboarda}




\subsection{Board B}\index{Board!Board B}
   The board B is where the ROMs chip containing all the assets and instructions specific to a game are attached via DIP sockets. The chips are not soldered but push-in mounted (and easily removable).

   Even though all ROM chips are located on the same board, they are not all part of an unified data system on an unified bus. 

   ROM chips are grouped depending on the system they belong to. Each group has its own data lines connected to a dedicated bus leading to a specific processor. 

   Thirty-eight DIP slots are visible on the board. They are grouped in four ROM groups. 

\vfill
\begin{figure}[H]
  \nbimg{90629B-3.jpg}
  \caption*{Empty board B}
  \end{figure}
\pagebreak

   There are 3x8 = 24 chips, referred as "GFX ROM", dedicated to storing GFX via sockets [1-8], sockets [10-17], and sockets [20-27] for a total of 12 MiB capacity. Because of the price of ROM, games were not budgeted to allowed the max capacity. Most titles were granted 2/4MiB, two (like Street Fighter II below) were allowed 6 MiB and one (Dynasty Wars) got a whooping 8MiB.

   One socket (9) with 64KiB capacity, referred as "z80 ROM",  stores both the Zilog 80 instructions and the music assets (instructions for the YM2151). 

   Two sockets (18-19) accounting for 256 KiB, referred as "OKI ROM", store ADPCM samples and are directly connected to the OKI chip. 

   Finally eight ROMs holding 1 MiB, referred as "M68K ROM", are dedicated to hosting m68k instructions. Note that even though they are related to graphics, palettes are also stored in this ROM group. 


\vfill
\begin{figure}[H]
  \nbimg{90629B.jpg}
  \caption*{Board B with Street Fighter 2 ROMs}
  \end{figure}
\pagebreak
% We will study in the storage subsystem how all these ROMs can be used to build 8-bit, 16-bit, or even 32-bit data buses.


\nbdraw{90629B}

Observant readers will have noticed unexplained black chips. For now we'll say they are in charge of bus traffic management. In the drawing above, \icode{STF29} handles the GFX ROM and \icode{IOB1} handles the M68K ROM. As an exercise, go back on page \pageref{fig:drawboarda} and guess which chip handle which ROM/RAM group. Or don't, I am just a book.
% \begin{figure}[H]
% \centering
% \nbdraw{90629B}
% \caption*{STF29 }
% \end{figure}



\subsection{Board C}\index{Board!Board C}
Board "C" hosts the "CPS-B" ASICs video chip. It is the beefy pixel generator directly connected to both the video system and the GFX ROMs. Capcom concentrated its anti-piracy measures in that chips and as a result revised the board "C" many more times than the board A and board B. 

This will be discussed extensively in the copy-protection section of this chapter.

% released many revision of its hardware in order to remain one step ahead of pirates. Since it concentrated most of its countermeasures on the CPS-B, it made sense to have the chip be on its own board.

\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{90628-C-2.jpg}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \nbdraw{90628-C}
\end{minipage}



\subsection{PALs}
The black chips on the drawing are called PALs (Programmable Array Logic). They play a crucial role in the creation of the memory maps. 

They pack boolean (\&, \textbar, !) logic between input and output lines to simplify the board, 
reduce the number of components, and allow tuning the logic without changing the PCB hardware lines.

\sdraw{0.45}{PAL16L8A}

 Often located near the memory chips group they affect, they are codenamed based on their function. Since most games use slightly different ROM layout, they usually feature different PALs. e.g: Street Fighter II's \icode{STF29} which organizes GFX ROM is named \icode{S224B} in Final Fight, and \icode{DM620} in Ghouls'n Ghosts.



\section{Logical Architecture}
The CP-System features eight processors, organized hierarchically. Commands issued at the top are carried out to sub-systems via a chain of reports. 

There is a strong isolation via layering where top systems are unable to access sub-systems resources. e.g: Control has no access to VRAM and audio ROM.

\begin{figure}[H]
\nbdraw{arch_hierarchy}
  \caption*{CP-System processor hierarchy}
  \end{figure}


The control system and its m68k is in charge of coordinating inputs (joystick, buttons, coin) and outputs. It can communicate with both the GFX and audio system main processors.

The audio system runs almost totally in isolation. It is connected to control via two 8-bit latches which the z80 actively polls to retrieve commands related to music and sound effects. Notice how these latches bridge different data bus width since control has 16 data lines while the audio system's uses 8 data lines.

The graphic system needs more communications and exposes not only its CPS-A and CPS-B registers but also the GFX RAM where the screen layout is described. The m68k and the CPS-A use the same bus to access the GFXRAM so the demarcation is not as clean as with the audio system which result in a bit of bus contention.  

The video system produces a stream of palette addresses (pen). Combined with the palette SRAM (ink) and the DAC, it outputs a signal towards JAMMA.
It is heavy duty in order to keep up with the 59.64Hz refresh rate inflicted on the display.

\begin{figure}[H]
\nbdraw{arch}
  \caption*{CPS-1 logical architecture with data lines}
  \label{cps1_arch}
  \end{figure}


\section{Control system}\index{Systems!Control}
The control system is the master of the platform. As a ruler it needs not excel at at specific task but to be able to direct and keep tabs on many components. A tailor made task for the immensely popular Motorola 68000.


\subsection{Motorola 68000 CPU}\index{Processors!Motorola 68000}

 Released in 1979, and clocked at 10 MHz (later upgraded to 12 MHz), the 68000 was not a particularly powerful chip by the late 80' standards with its two stage pipeline\cite{M68000fv} (prefetch, exec) and no cache. Its 1.7 MIPS placed it on par with an Intel 286 10MHz (1.5 MIPS). By 1989 it was already two generations old behind the 1984 M68020 (3 MIPS) and the 1987 M68030 (5 MIPS)\cite{mips}.

\nbdraw{mips}

This lack of velocity did not prevent a a plethora of manufacturers to use it as their backbone. On the list of machine adopting the m68k can be found the Atari ST, Amiga, Sega's System 16, Genesis, Sega CD, NeXT Computer, Apple Macintosh, Sharp X68000, and even SNK's Neo-Geo. It was even IBM's first choice for it PC before production issues allowed the Intel's 8088 to prevail\cite{ieee20170630}. 

Performance is not what made the 68000 rein as the prime hardware designer choice. The reason this CPU was so successful is because it was a great team player.

While most machines used 16-bit address system, its 24-bit address space allowed the 68000 16 MiB of RAM which was considered humongous at the time. This was a considerable advantage when it came to map peripherals. There is so much address space that, had they wished so, Capcom engineers could have allowed the 68000 to see all RAM and all ROM of all systems on the CPS-1.

Other CPUs used small address registers resulting in the infamous segmented addressing, Motorola gave its CPU 32-bit data and address registers. The elegant flat addressing and eighteen registers make it a processor loved by programmers. 


\begin{figure}[H]

 
\sdraw{0.75}{68000}
 \caption*{Motorola 68000 pin-outs}
\label{68000drawing}
  \end{figure}



The 68000 is brought to life via its clock (\icode{CLK}), +5V (\icode{VCC}), and Ground (\icode{VSS}) pins.

The bus is made of \icode{D0-D15} for data, \icode{A1-A23]} for addresses. Address ACK (\icode{AS}), Read/Write (\icode{R/W}), \icode{UDS}, \icode{LDS}, and Data ACK \icode{DTACK} are bus control pins.


Arbitration to allow peripherals to master the bus is done with Bus Request (\icode{BR}),  Bus Grant (\icode{BG}) and Bus Grant ACK (\icode{GBA-K}).

The interrupt system is made of a generous three pins \icode{IPL0}, \icode{IPL1}, \icode{IPL2}, and \icode{VPA}. While other CPUs like the x86s or Zilog's z80 have a single interrupt line, the multiple \icode{IPL} allow to code interrupt number directly via the pins without need for an interrupt controller. How this is leveraged will be explained in the programming section.


System control is done via Error (\icode{BERR}), Reset (\icode{RST}), and Halt (\icode{HALT}). 

Finally, processor status is given by \icode{FC0}, \icode{FC1}, \icode{FC2} and Peripheral control is done via sync (\icode{E}) and valid sig (\icode{VMA}).

\begin{trivia}
Motorola's CPU name is due to its total number of transistors totaling 68,000 units. The 68030 and 68040 had more transistors than their name indicate. 
\end{trivia}

Despite the raving description provided in the previous page, the 68000 could be a peculiar CPU to program. Its most famous shortcoming involved memory alignment. While Intel's line of CISC allows random memory accesses (at the cost of a great performance penalty), Motorola's CPU will \icode{HALT} while attempting to read/write memory not aligned on a 16-bit (\icode{WORD}) boundary.

This limitation is rooted all the way down to the CPU pins where there is no \icode{A0} line. Pins \icode{UDS} and \icode{LDS}indicate which of the high-byte or low-bytes part of a 16-bit \icode{WORD} to access.


\begin{trivia}
 The 68000 has 32-bit address registers but used only 24-bit addresses. These 8 bits of "unused" pointers were hijacked by system engineers to mark address as "locked" or "purgeable", making their programs forward-incompatible. 
\end{trivia}

Perhaps the best testament to the quality of the 68000 design is that, as of 2022, 43 years after its release, Motorola's immortal CPU is still in production.


\subsection{Motorola 68000 "work" RAM}
With a 16-bit data bus processor it would have been fair to expect a memory system built with 16-bit RAM chips. However these were expensive and a closer look reveals a bunch of \icode{65256BLSP-10} offering fast access time (100ns SRAM) and 32 KiB capacity but only 8 data lines.

\sdraw{0.58}{65256BLSP-10}
\pagebreak

Using cheaper of-the-shelves 8-bit RAM chips instead of 16-bit RAM chips helped to drive down the cost. Moreover, these are not hard to combine into a 16-bit RAM system via two-way interleave.

\begin{figure}[H]
\nbdraw{64k_ram}
\caption*{32 Ki x 16-bit RAM system with two 32 Ki x 8-bit chips}
\end{figure}

The two \icode{65256BLSP-10} are not aware of each others. They are connected to the same 15 address lines and the same control lines for Write Enabled (\icode{WE}) and Read Enabled (\icode{OE}). However, they are connected to different lines of the data bus.


 \begin{trivia}
Interleaving chips help to beat memory latency by increasing throughput. Early GPU such as the Voodoo 1 and Voodoo 2 by 3Dfx extensively relied on this technique, even using four-way interleave to keep up with the bandwidth requirements\cite{TheStoryOf3Dfx}.  
 \end{trivia}


Notice how the address lines of the SRAM chips are directly connected to the 68000 address bus. There is no mechanism to prevent these two chips to respond to all bus requests. 

This is an over-simplification to introduce complexity progressively. We will see next how chips are organized to not conflict with each others.

 \begin{trivia}
 64 KiB of work RAM seems like a lot but was not always enough. Some games found themselves with not enough RAM and too much GFXRAM. Street Fighter 2 Champion Edition programmers resolved to generating and executing instructions from the GFXRAM\cite{mame_driver}!
 \end{trivia}
\pagebreak








\subsection{Motorola 68000 Program ROM}


The 68000 instructions are provided by eight \icode{27C010} which are 128 Ki x 8-bit chips. They work like the \icode{65256BLSP-10} except that they have sixteen address lines instead of fifteen (and therefore higher capacity).

Like the RAM, ROM chips are combined via two-way interleaves to provide 16-bit data. What is peculiar is how the four pairs are arranged to build a memory system with a larger capacity.


\begin{figure}[H]
\nbdraw{128k_ram}
\caption*{Two first pairs. 4 x (128 Ki x 8-bit) making a 256Ki x 16-bit system}
\end{figure}

To place one pair after another in memory space, the \icode{CE} (Chip Enabled, sometimes labeled \icode{CS} for "Chip Selected") pin is leveraged. Asserting it let a chip respond to address request while de-asserting it keeps it dormant. All CEs on all chips on all boards are controlled via PALs.

In this example, the first four out PAL pins must be programmed as follows.

\lstinputlisting[style=CStyle]{src/code/pal.c}


The first pair of chips is mapped to addresses \icode{0x000000} while the second pair is mapped to \icode{0x40000}. With the same logic, two more pairs of \icode{27C010} are mapped at \icode{0x80000} and \icode{0xc0000} for a total of 1 MiB ROM.



By now, it should be abundantly clear that the \icode{CE} / \icode{CS} lines are absolutely crucial to build a memory map. Even though they won't be mentioned again, keep in mind they impact every chips on the boards (except the CPUs).

\subsection{68000 Memory Map}

Thanks to the PAL chips enabling/disabling components, the 68000 memory space is partitioned. The result is summarized in a "memory map".

\begin{figure}[H]
{
\begin{tabularx}{\textwidth}{rrrX}
% \toprule    
  \textbf{Start } & \textbf{End  } & \textbf{Size } & \textbf{Function } \\               
  \toprule    
  \texttt{0x000000} & \texttt{0x3FFFFF} & 3 MiB & ROM \\
  \toprule    
  \texttt{0x800000} & \texttt{0x800007} & 8 B & JAMMA Players inputs \\
  \texttt{0x800018} & \texttt{0x80001F} & 8 B & JAMMA Dip Switches \\
  \texttt{0x800030} & \texttt{0x800037} & 8 B & JAMMA Coin sensors \\
  \texttt{0x800176} & \texttt{0x800177} & 1 B & Kick harness \\
\toprule    
  \texttt{0x800100} & \texttt{0x80013f} & 64 B & CPS-A registers\\
  \texttt{0x800140} & \texttt{0x80017f} & 64 B & CPS-B registers\\
\toprule    
  \texttt{0x800180} & \texttt{0x800187} & 8 B & Sound commands (latch 1)\\
  \texttt{0x800188} & \texttt{0x80018F} & 8 B & Sound commands (latch 2)\\
  \toprule    
  \texttt{0x900000} & \texttt{0x92FFFF} & 196 KiB & GFXRAM\\
  \texttt{0xFF0000} & \texttt{0xFFFFFF} & 64 KiB & Work RAM \\
  % \toprule    
\end{tabularx}%
}\caption*{Control system memory map.}
\end{figure}

\subsection{Putting it all together}

The details of the 68000 operations will be studied in-depth in the next chapters but we can already guess how the CPU operates based on what it has access to.

As the m68k boots, it starts to retrieve instructions from it ROM. For regular operations such as store/load, and also to keep track of its call stack, it uses its work RAM. 

The game engine starts and reads the configuration set by the arcade operators via the DIP switches. While the game runs, the CPU continuously polls the JAMMA registers.

Acting as the orchestrator, the engine detects JAMMA inputs and delegates generation of video and audio signal to its subordinates towards JAMMA outputs.

For the video, the m68k describes the scene to be displayed via the GFXRAM. The graphic ASICs are then instructed how to retrieve the scene data via their registers. 

For the audio, the m68k issues simple commands to the z80 via two 1 byte latches using a protocol detailed later.
  











\pagebreak
\section{Audio system}\index{Systems!Audio}
The audio system runs in isolation from everything else. It has its own bus, its own RAM, its own ROM systems, and its own oscillators. Its only opening to the outside world are two latches to receive commands from the control system and two JAMMA pins where to output sound.

The component in charge is a surprisingly light-weight z80 running at 3.58 MHz.

\subsection{Zilog 80 CPU}
Released in July 1976 by Zilog, the z80 was an intended as an Intel 8080 killer thanks to a compatible instruction set. It ended up becoming an icon of the 70s, sharing the front-scene with the equally mythical MOS 6502 well into the mid-80s. 

The z80 was widely used in home computers, notably featured in the Sinclair ZX Spectrum and the Amstrad CPC. It also found its way in military applications, musical equipment (Roland Jupiter-8), embedded systems and multiple coin-ops arcades. 

As an 8-bit era processor, the z80 uses 8-bit data registers, 8-bit data bus, 16-bit addresses, and 16-bit address bus. In terms of processing power, despite its "overlapping fetch/execute" design, the CPU had become particularly weak by the late 80s standards with 0.45 MIPS. It was three times slower than the 68000 featured in the control system\cite{mips}. 

\nbdraw{mips_z80}

Processing power was not to be the deciding factor to elect the master of the Sound system. Thanks for its two powerful co-processors, the CPU would not have to process much data, making the MIPS figure irrelevant. A much more important characteristic would be how well it integrated with its two sidekicks.

Thanks to its 8-bit design, the z80 was a perfect fit for the 8-bit YM2151 and 8-bit MSM6295. Having been around for a while, the "outdated" CPU was inexpensive. Lastly, it enjoyed a good reputation thanks to its simple programming interface.

\begin{trivia}
The number of pin lines on a chip dictate their packaging names. DIP (Dual In-line Package), like the z80 below, are recognizable by their two lines of pins. The Motorola 68000 on page \pageref{68000drawing} with its four sides of pins belongs to the "Chip carrier" family. Packaging can use materials such as plastic or ceramic and are referred using increasingly barbaric acronyms such as CLCC or PLCC.
\end{trivia}

\sdraw{0.9}{z-80}\index{Processors!Zilog 80}

The z80 comes to life thanks to its \icode{CLK} (clock ), \icode{+V5} (power), and \icode{GND} (ground) pins.

The bus lines are dedicated \icode{D0-D15} for addresses and \icode{A0-A7} for data. For control, \icode{RD} indicates read while \icode{WR} indicates a write operation. \icode{WAIT} is used to add waitstates. 

Although it is capable of relinquishing control of the bus via \icode{BUSRQ} (Bus Request), \icode{BUSAK} (Bus Acknowledge), \icode{MREQ} (Memory Request), and \icode{IORQ} (IO Request), the z80 completely own its bus and never shares it. 

In fact, the \icode{BUSRQ} and \icode{BUSAK} pins are not even connected.  Because it is isolated via latches, the z80's bus never suffers contention.


Other pins are \icode{INT} Interrupt line, \icode{NMI} Non Maskable Interrupt, \icode{RESET} Restart CPU, \icode{HALT} Waiting for interrupt, \icode{M1} Fetching next instruction.

\label{z80_pinRFSH}
The \icode{RFSH} pin (ReFreSH signal) tics at regular intervals to trigger DRAM refreshes. The sound system uses only SRAM so it is not used although this pin was re-purposed in a creative way for CP-S 1.5 "Kabuki" (page \pageref{kabuki}).

 This is not used on the CP-System system since all RAM is Static RAM. Only one components, the VRAM, uses DRAM but it is located on the polar opposite side of the board.

\pagebreak

\subsection{z80 Work RAM}
The amount of RAM provided to the z80 may appear scandalously small by today standards. Because all it has to do is forward request from the latches to the MSM6295 and feeds the YM2151 music notes, the z80 bus is connected to a single 2Ki x 8-bit \icode{CXK5816SP} chip.

\subsection{z80 ROM}
The ROM is made of a simple 64Ki x 8-bit \icode{27C512} chip. It is much larger than the RAM in order to store YM2151 instructions along the z80 instructions. 


These ROM chips work alike those the one already studies with pins such as power, ground, addresses, data, control, and of course the crucial \icode{CE}. What is peculiar is that the z80 uses 16-bit address registers which grants 65,536 addresses. There is not enough address space for all registers, ROM, and RAM totaling 67 KiB.

The solution is to map only the portion of the ROM that contain instructions (32KiB) statically and to use a banking system to provide a 16 KiB "view" into the remaining 32KiB of the ROM where the music assets are stored. This is accomplished simply with a PAL (\icode{SOU1}) and was the source of great pain to the developers (page \red{XXX}).


Hopefully this awful bank switch control 
 will leave no doubt with regards of the awesomeness of the 68000 and its 24-bit flat addressing system. 

\subsection{z80 Memory Map}

\begin{figure}[H]
{
\begin{tabularx}{\textwidth}{rrrX}
\toprule    
  \textbf{Start } & \textbf{End  } & \textbf{Size } & \textbf{Function } \\               
  \toprule    
  \texttt{0x0000} & \texttt{0x7FFF} & 32 KiB & ROM (32 KiB out of 64 KiB)\\
  \texttt{0x8000} & \texttt{0xBFFF} & 16 KiB & Bank-switched view of rest of ROM\\
  \toprule    
  \texttt{0xD000} & \texttt{0xD7FF} & 2 KiB & RAM \\
\toprule    
  \texttt{0xF000} & \texttt{0xF001} & 2 B & YM2151 registers\\
  \texttt{0xF002} & \texttt{0xF002} & 1 B & OKI OKI6295 registers\\
  \texttt{0xF004} & \texttt{0xF004} & 1 B & Bank Switch control (\icode{SOU1})\\
  \texttt{0xF006} & \texttt{0xF006} & 1 B & OKI MSM6295 H / L mode\\
  \toprule    
  \texttt{0xF008} & \texttt{0xF008} & 1 B & Sound commands (latch 1)\\
  \texttt{0xF00A} & \texttt{0xF00A} & 1 B& Sound commands (latch 2)\\
  \toprule    
\end{tabularx}%
}\caption*{Audio memory map.}
\end{figure}



\subsection{YM2151}\index{Processors!Yamaha 2151}

Selecting the music chip was not a matter of shopping vendors but rather to pick one from Yamaha. Thanks to the licensing of Frequency Modulation (FM) patents from Stanford in 1975, the Japanese founder ruled the world of electronic music.

\begin{trivia}
Yamaha licensed FM technology from Stanford starting in 1975 at the cost of \$10/keyboard. Licensing was renegotiated in 1985 on a per-chips basis\cite{fm_licensing}.

\end{trivia}
Three architectures stood out in the early 90s. Among the OPL2 3812 and the OPN2 2612, the OPM (\textbf{OP}erator type \textbf{M}) 2151 was selected for its versatility. 



The principle of Frequency Modulation is to use simple wave forms to modulate each other in a Modulator/Carrier pair resulting in complex waveforms\cite{fmProgramming}.

\begin{figure}[H]
\draw{fm_carrier}
\caption*{Carrier wave}
\end{figure}

\begin{figure}[H]
\draw{fm_signal}
\caption*{Modulator wave}
\end{figure}

\begin{figure}[H]
\draw{fm_result}
\caption*{Resulting wave}
\end{figure}







The YM2151 is able to play 8 channels (a.k.a voices) of audio. Each channel consists of four operators (a.k.a slots) which can be setup to produce either percussion or instruments sounds.  

Slots are even able to modulate their own output. With proper adjustments virtually any wave form can be obtained. 
 
\begin{figure}[H]
\nbdraw{waveforms}
\caption*{Some of the wave forms the YM2151 can generate}
\end{figure}


Other parameters can be applied to a channel's output. The "envelop" features adjustable Attack, Decay , Sustain, and Release Rate. 

\nbdraw{adsr}

The huge advantage of FM synthesis is the small amount of data required to store a melody. After the instruments are defined, only the notes of each instruments and their tempo need to be recorded. Yamaha's technology is so efficient that, in Street Fighter 2, the whole Sagat main stage music (2mn6s, 10KiB) use fewer bytes than one "Tiger Uppercut"'s ADPCM sample (777ms, 12KiB).




Looking at the YM2151, we see previously discussed pins such as \icode{+5V}, \icode{GND}, and \icode{CS}. The \icode{CLK} is connected to the same oscillator as the z80 for a frequency of 3.58MHz. The \icode{D0-D7} address/data pins (multiplexed via \icode{A0}) fit exactly the z80's 8-bit data bus with read (\icode{RD}) and write (\icode{WR}) control.


A pin is of particular interest to us. \icode{IRQ} allows the YM2151 to generate interrupts based on two internal counters, It is detailed in the programming section.

\sdraw{0.48}{YM2151}

The only drawback of this chip is that is features no DAC (Digital to Analog Converter). It generates a signal on the Serial Output (\icode{SO}). 

\subsection{YM3012}\index{Processors!Yamaha 3012}

The YM3012 is a DAC connected to the YM2151 digital output \icode{SO}. The analog signal it outputs on \icode{CH1} and \icode{CH2} is mixed with the signal from the OKI6295 towards JAMMA.

\sdraw{0.95}{YM3012}


\subsection{MSM6295}\index{Processors!OKI MSM6295}

For audio sample playback, Capcom spared no expenses and selected a chip capable of 4-bit ADPCM audio decompression over four channels, the MSM6295 (a.k.a OKI). 
% capable chips by the past with the MSM5205 by OKI Semiconductor. For the CPS-1  they went with a steroids version,

Despite running at only 1MHz the MSM6295 is a god sent to a game board designer. It does not need instructions since its function is fully hard-coded. Its address (\icode{A0-A15}) and data (\icode{D0-D7}) lines are directly connected to its own 256 KiB ROM, on a local bus where assets are stored which avoid contention with the z80 bus. 

These make it a fully enclosed digitized sound system only communicated via its input lines (\icode{I0-I7}), a perfect match for the z80 data bus, from which it receives commands.

To get to work, the OKI only needs to receive a sample ID [1-127], a channel [1-4], and a volume [0-127]. Via a lookup table in its ROM the sample offset is retrieved and playback starts with an analog signal generated on \icode{DA0}. 

\sdraw{0.75}{MSM6295}

Up to four channels can be active simultaneously. Since games don't need that many sound effects simultaneously, two channels are usually reserved for sample while two are dedicated to embellishing musics.

ADPCM lossy compression is able to divides space consumption by three by converting 12-bit PCM samples into 4-bit nibbles. 


\subsubsection{Making choices}
If the choice of the Yamaha music chips left little ambiguity to the hardware designer, the MSM6295 was a different story.

First off all, the sampling rate expected in ROM is directly correlated to the clock rate of the MSM6295. Second of all, the OKI can operate in two modes via its \icode{SS} pin. In high quality (H), the divisor is 132 and in low quality (L) the divisor is 165.

Clockable between [1MHz-5MHz] with two modes, the goals was to maximize quality while minimizing required storage. The table shows that the best quality (37kHz) only allowed to store 13 seconds of samples while the worse (6060Hz) gave 86 seconds.
\begin{figure}[H]
{
\setlength\cmidrulewidth{\heavyrulewidth} % Make cmidrule = 

\begin{tabularx}{\textwidth}{Ycccc}

  & \multicolumn{2}{c}{H} &  \multicolumn{2}{c}{L} \\
  \cmidrule(lr){2-3}
  \cmidrule(lr){4-5}
  \textbf{MHz } & \textbf{Sampling Rate (Hz)} & \textbf{Time (s)} & \textbf{Sampling Rate (Hz)} & \textbf{Time (s)}\\               
  \toprule    
  \texttt{1} & 7575 & 69 & 6060 & 86\\
  \texttt{2} & 15151 & 34 & 12121 & 43\\  
  \texttt{3} & 22727 & 23 & 18181 & 28\\
  \texttt{4} & 30303 & 17 & 24242 & 21\\
  \texttt{5} & 37878 & 13 & 30303& 17\\
  \toprule    
\end{tabularx}%
}\caption*{MSM6295 operating modes (with ROM = 256 KiB).}
\end{figure}

In the end, Capcom connected the OKI to the GFX crystal (16MHz) and divided frequency by 16 to run at 1MHz. Along with a SS pin set to H, the system uses 7,575Hz sampling rate.




\subsection{PCM 101}
\index{ADPCM!Decompression}
The MSM6295 input and output are respectively ADPCM and PCM streams. To deepen the understanding of the chip means to extensively study how \textbf{P}ulse-\textbf{C}ode \textbf{M}odulation works.

Whether it is recorded or played, PCM is a series of value directly representing the position of a device diaphragm. In the case of recording the diagram is in a microphone, whereas upon playing, it is in a loud speaker.

\pagebreak

\begin{figure}[H]
\nbdraw{speaker}
\caption*{A speaker cone moves proportionally to the PCM values.}
\end{figure}


The sampling rate and the bit depth are the two parameters impacting the fidelity of the signal capture/restitution.

\begin{figure}[H]
\nbdraw{pcm}
\caption*{PCM values (4-bit samples) quantizing an analog signal}
\end{figure}


The higher the sampling rate (on the X axis) , the more often the cone position can be adjusted. The higher the bit depth (on the Y axis) , the more accurately the cone position can be set. Stereo is achieved by interleaving two PCM streams.





Sound quality increases linearly with the data rate.
\begin{itemize}[topsep=0pt]
\item Land-line phones use 8,000Hz/8-bit mono using 8,000 Byte per Second.
\item CDs uses 44,100Hz/16-bit stereo using to 176,400 Byte per Second.
\end{itemize}



\subsection{ADPCM compression}
ADPCM is able to take 12-bit PCM samples and compress then as 4-bit samples by encoding only the difference between PCM samples. Decompressing an ADPCM stream consist in adding a delta value to the last decompressed  sample, over and over again.

The delta is encoded with a system of weighted offset called "step" which is accurate for small variation but coarser when deltas increase. 

The first bit in a nibble indicates the sign of the delta (+/-). The three other give a "magnitude". The magnitude depends on the "step size" of the ADPCM decompressor.

\begin{figure}[H]
\sdraw{0.3}{adpcm_nibble}
\caption*{ADPCM nibble}
\end{figure}


In its initial state, the step size is 16 which means bit three is +/-16, bit two +/-8 and bit one +/-4. In this state, the delta to be applied can vary from 0 (\icode{b000}) to 28 (\icode{b111}). 

The decompressor constantly monitors how much of the step size was used. The step size is adjusted after each sample via a  predetermined transition table indexed via the magnitude value. 

\lstinputlisting[style=CStyle]{src/code/adpcm_transition.c}



The transition table dictates how to adjust the step size index. ADPCM is aggressive in increasing the index for magnitude values ranging from 4 to 7 where it is bumped between \icode{2} and \icode{8}. Meanwhile it is conservative in decreasing it for small magnitude values ranging from 0 to 3 where it is always modified in \icode{-1} decrements.








\pagebreak
\section{Video system}\index{Systems!Video}
The goal of the video system is to pilot the CRT (Cathode-Ray Tube) where images are rasterized for the player to see.

Even though it is connected via an intermediate JAMMA port, there is no abstraction layer or custom protocol. The four red, green, blue, and sync JAMMA output pins are connected directly into the CRT inputs.

\begin{figure}[H]
\nbdraw{rgb_wires}
\caption*{The four wires needed to drive a CRT}
\end{figure}


There are four wires but in fact five signals are transmitted. Each red, green, and blue signal have their own wire but the sync wire carries two signals multiplexed as the horizontal sync pulse and vertical sync pulse. Because it composes two signals, it is called CSYNC (Composite SYNC). 

These five signals are everything a CRT needs to work. 

\begin{trivia} The CRT is purely a signal consumer. It never sends anything "back" on these wires. It is a common misconception that the CRT emits VSYNC. In fact, all signals are generated by the video system.
\end{trivia}


\subsection{CRT 101}

Because the timing of operations is propagated deep into the GFX system, it is important to understand how a CTR works.

At its core, a CRT is a line drawing machine. It draws horizontal lines one after an other, from left to right and top to bottom. While is scans a line, three analog signals (one for each RGB colors) indicates the quantity of electrons to shot from three guns. The higher the signal, the more electrons are shot and the more vivid the color.


On the way toward the panel, electrons are filtered through a shadow mask to make sure they hit the proper type of colored phosphor receptacles which are grouped by three in RGB "slots". The electron beam-slot is not a one to one relationship. The beam can be larger or smaller than a slot.


\begin{figure}[H]
\draw{shadow_mask}
\caption*{Electon gun, mask, and slots}
\end{figure}

Slots are not aligned horizontally. When the gun shots electrons it doesn't really know on which slots they will land. They can hit all in one slot, or two halves of two slots or anything depending on slot density and beam dispersion. 

The only guarantees are that the electron from a canon color always land in a phosphor receptacle of the same color and the electron beam height is constant on a line.

\begin{figure}[H]
\draw{triad_slots}
\caption*{A scanline of electron hits wherever.}
\end{figure}

Smaller slots can render the horizontal analog signals with better fidelity.


\draw{triad_slots_hd}



 With these duality of lines and signals, a CRT is both a numeric and an analog system. The number of scanlines is finite (i.e: there is a set number of these elements) but there is no horizontal number of "dots", "points", or "pixels" since the three color intensity signals are analog.


\subsection{Syncing}
The RGB signals describe lines to be drawn but to render an image properly the CRT needs to know where to draw them. The control signal allows the CRT to synchronize the cannon orientation with the lines color signal so they are rasterized where they should. Without syncing, the image appears distorted. 

\begin{figure}[H]
\simg{0.9}{desync.jpg}
\caption*{A desynced CRT. Lines are correct but not located where they should be.}
\end{figure}





The horizontal syncing is done via a HSYNC signal and the vertical syncing is done via a VSYNC signal. These signals are detected by the CRT to position the gun properly with regards to the origins sets in the upper left.

VSYNC tells the CRT that it should reset the gun's vertical position to 0 at the top of the screen. This motion from bottom to top is called vertical retrace. During the retrace the gun must stop shooting electrons. This is achieved by requesting a black color on the RGB signal. This "blanking" of the RGB lines happens a little bit before and after VSYNC. The total time not drawing anything is called VBLANK.

HSYNC tells the CRT that a line has been drawn and the gun horizontal position should be reset to the left of the screen. This motion is called horizontal retrace. Alike the VBLANK, there is a HBLANK timespan.

By detecting VSYNC and HSYNC, the CRT can "synchronize" the signal with the guns and draw the line at the right location on screen.



\pagebreak
\subsection{Fields}

The process of drawing scanlines over the screen, also called "Raster scan", is flawed as described. If the gun draws a line and upon HSYNC goes back to the left, it would be drawing the same upper left line over and over again. 

It is barely noticeable but scanlines are not drawn straight. There is a slight downward slope. This way, when HSYNC is received and horizontally position is reset, the next line is drawn below the previous.



\nbdraw{p_scan}

As long as VSYNC is issued at the same time as a HSYNC, the CRT lines are always on the same location on the screen.

In then next drawing, see what happen if VSYNC \circled{3} is issued in the middle of the last line being draw (between HSYNC \circled{2} and \circled{4}).

\nbdraw{i_scan}

Because only half a line was drawn at the bottom, it only progressed down half a space vertically. As a result, the next frame will be interlaced with the previous. This is a technique used by TV broadcast such as NTSC in USA and Japan. A signal transmit frames at 30Hz, each contains two "fields" to be drawn interlaced at 60Hz.

While interlacing is acceptable for TV images, it is not for gaming since the artifacts are disturbingly visible on moving text and sprites. 

The solution to this problem is to only use one field and never display anything on the other one. Doing this means designing a video system where VSYNC is always issued along with a HSYNC. The drawback is that since CRTs were build to display interleaved images, they provision space between lines. 

Since this space is not used for another field, the resulting effect is black horizontal strips on the screen. Note that the problem is compensated by line bleeding so the black lines are not as big as visible lines.

\begin{figure}[H]
\img{sf2_4_3_interlaced.png}
\caption*{Non-interlaced scanning show a black space between lines.}
\end{figure}


% HSYNC, VSYNC, and color signals don't seem like a lot but they allow hardware designers a great deal of freedom and mandate tuning decisions. 

Besides interlacing which had to be avoided, many other key decisions must be made by the hardware engineers. Namely, how many lines to draw, how much horizontal resolution to use, and at what frequency should the screen be full redrawn (a.k.a: "refreshed").





\subsection{Making choices}
 The main figure to consider when crafting a video system is how fast the display can draw lines. In the late 80s, standard CRTs horizontal scan rate was 15.7 kHz which means they could draw 15,720 lines per second.





\subsubsection{Vertical scan rate}
Because these CRTs were made to display NTSC signals, they were guaranteed to sync with VSYNC in the vicinity of 60Hz. Combining this figure with the horizontal scan rate gives 15,720 / 60 = 262 lines per image.


\subsubsection{Picking a vertical resolution}
Out of these 262 lines, not all of them can be used. The issue is that when VSYNC is emitted, the electron gun resets vertically in a nearly instantaneous fashion. This causes the electron beam wobbles for a bit afterward which results in visible artifacts. To avoid visual disturbance, the electron beam is stopped by requesting black on the color wires until the stream stabilize. 

Besides mechanical issues, varying quality of CRT have to be accounted for. Some screen drew lines outside of their visible bounds, a phenomenon known as over-scan. To solve this problem, the number of lines for colors had to further be reduced to ensure a "safe area" would always been drawn regardless of the CRT overscan properties.

% Considering these two constraints, Capcom settled on discarding 38 lines, keeping 224 active lines


\subsubsection{Picking an horizontal resolution}
Similar constraints come into consideration when choosing an horizontal resolution. Alike VSYNC, HSYNC induces wobbling which must be hidden which reduces the length of a line. Similarly, horizontal overscan must be factored in.

Moreover, even though the color signal is analog, there is still a maximum limit due to bandwidth limitation. CRTs of the era were able to keep up with a maximum of 512 color changes per line.

Ideally, the proportion of horizontal points versus the number of lines would result in an aspect-ratio of 4:3 perfectly matching the CRT dimensions. In this case, there would be no distortion when the signal is rendered on the physical screen. A condition called "square-pixels". 


\subsubsection{Making choices...}
Besides the vertical and horizontal "rules", Capcom engineers had additional constraints.

First of all, because the GFX system is digital, they had to pick dimension that could be represented as integer. There was also condition dictated by the graphic system which required both axis to be multiple of 8 (for the tilemaps we will study in the next section).

To check all the boxes, Capcom had the choice between only two resolutions, 288x216 and 320x240. Ultimately they picked neither. They gave 38 lines to VBLANK and kept 224 active lines\cite{petitCRT}. Horizontally, they left 128 elements to HBLANK and kept 384 active ones.  

Going for 384x224 was an interesting decision from an aspect-ratio standing point. Other manufacturers such as SNK had also dropped 4:3 with their Neo-Geo using 320Ã—224 but the resulting aspect ratio of 10:7 was close to 4:3. With its 12:7, the CPS-1 drew many more dots horizontally and the image appeared vertically compressed. 



% \begin{trivia}12:7 is to closed to 16:9 that, years later, people new to emulation actually wondered if Capcom actually intended games to be played in 16:9 instead of 4:3!
% \end{trivia}

The result is that the CPS-1 does not have square "pixels". It has wide rectangular "pixels". This was a huge problem for artists. If they digitized their drawing as is, the CRT would present to players a rendition non-conforming to their original vision.

% DRAWING ASPECT RATIO HERE

\begin{q}{Akiman, Street Fighter 2, Lead Artist\cite{akiman}}
When I was working on my first CPS-1 game, Forgotten Worlds, I noticed the problem of aspect ratio right away. 

- "The pixels are not square!" I told my boss.\\ 
- "Impossible, I ordered them to be square!" he replied.

He then proceeded to call hardware on the spot.\\ 
- "The pixels are square!" he added.\\
Later I protested again to which my boss replied it was a calculation error.
\end{q}

\pagebreak
\begin{trivia}
The designers of R-Type in 1987 played on CRT tolerance in order to craft a video system with increased vertical resolution. 

They chose the VSYNC to pulse at 55Hz. This gave them extra time between frames so they had to sacrifice fewer lines to VBLANK. They reinvested this saving into more vertical lines to reach 256.

Increasing horizontal resolution is just about improving the analog signal. This is what the people at Irem did to push it to 384. In the end, the game enjoyed a higher than competitors resolution of 384x256 at the cost of a 5Hz refresh penalty.
\end{trivia}



\subsection{Colors}
With a resolution and a refresh rate, the last characteristic of the video system to decide on was the color depth. 

The CPS-1 uses 16 bits to encode colors with 4 bits per RGB components for a total of 12 bits allowing 4,096 colors. 


\begin{figure}[H]
\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{clear_4bit.png}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.49\linewidth}
  \simg{1.0}{dark_4bit.png}
\end{minipage}
\caption*{CPS-1's 12-bit per color cube.}
\end{figure}
  
The four remaining bits express brightness to allow 16 shades of a base color. In total, 65,536 different colors are available to artists.

\begin{figure}[H]
\nbdraw{brightness}
\caption*{All 15 shades of red using a \icode{\{0xF,0x0, 0x0\}} base color.}
\end{figure}

\subsection{Putting it all together}

Knowing how a CRT works and what decisions Capcom engineers made, we can now understand the video signal as a whole.

With a "pixel" clock coming from the GFX oscillator (16MHz) halved to 8MHz, a color is issued every 1s / 8MHz = 125ns.

The horizontal resolution of 512 mandates a HSYNC to be generated every 512 * 0.125 = 64$\mu$s. The resulting refresh rate is 8MHz / (512x262) = 59.637Hz and a VSYNC is issued every 1000ms/59.637 = 16.7ms.


A summary drawing exposes all timing and regions as well as the significant part of the image not usable due to horizontal and vertical blanking.



\nbdraw{sf2_withoverscan_zero}


% \begin{trivia}
% The horizontal blank between the end of a scanline and hsync is called the "front porch". The blank section between hsync and the start of the next scanline is called the "back porch".
% \end{trivia}

Keep in mind that HSYNC happens 262 times (blue vertical line) but VSYNC occurs only once. The dashed horizontal red line in the previous drawing is only here to represent where the electron gun reset to the top of the screen.

The sheer amount of black in the drawings show the extend of the overhead associated with beam and overscan management. But the time spent not drawing is not wasted. It is leveraged to perform background operations such as modifying palette colors. Sixteen lines are necessary to a palette page (32 palettes).

\begin{figure}[H]
\nbdraw{sf2_withoverscan}
\caption*{Same concept but closer to what happen in CRT screen space.}
\end{figure}


\subsection{From pen to palette to color}

To generate the color signals, the CPS-1 uses a palette system storing colors via 4 x 2Ki x 1B \icode{CXK5814P-35L} SRAM chips.


These simple memory elements features pinouts explained earlier, Power \icode{+5V}, Ground \icode{GND}, Addresses \icode{A0-A10}, Data \icode{D0-D7}, Write (\icode{WE}), Read (\icode{OW}), and Chip Enabled (\icode{CE}).

What is uncanny is that the component connected to the address lines is not the one connected to the data lines.
 % Instead data is routed towards a DAC.

\sdraw{0.45}{CXK5814P-35L} 




The CPS-B drives the address bus at 8MHz to generate the DAC 16-bit inputs which in turn generates three analog Red, Green, and Blue signals. In parallel, it generates the HSYNC and VSYNC signals, composited into CSYNC.

Notice how one line out of twelve is used not for addressing but to \icode{CE}ing chip pairs. 




\nbdraw{video_lookup}




Colors are grouped into palettes containing 16 units. As will be studied later, the GFX system features 6 layers and each of them allows 32 palettes (called page). This brings the total to 6*32*15 = 2,880 colors which requires 12-bit to be indexed.

% 3,072 colors accounts for 3,072*2= 6,144 bytes. There is a little bit of palette SRAM not used.

 The palette SRAM chips are nearly constantly used to generate colors. Their content can only modified to during VBLANK (cf: Importance of BLANKing in last section). 
 % Designing the machine with long blanking was paramount to allow large updates. 



 

% \begin{trivia}
% 8 KiB but only 6 KiB is used
% \end{trivia}

% If we were to look at the CRT signals, we would see not only the active scanlines (those visible to users but also the huge HBLANK and HBLANKs section. 


% If this representation help visualizing the blanks, it is not how the CRT inteprets it. By "syncing" (placing HSYNC + VSYNC in the upper left), we see an image closer to what the CRT's gun actually does.
\pagebreak




Twelves palettes from the characters of a famous Capcom fighting game. Can you recognize them?

\nbdraw{palette_ryu}

\nbdraw{palette_ken}

\nbdraw{palette_chun}

\nbdraw{palette_honda}

\nbdraw{palette_guile}

\nbdraw{palette_zan}

\nbdraw{palette_blanka}

\nbdraw{palette_dahlsim}

\par\noindent\rule{\textwidth}{0.5pt}

\nbdraw{palette_boxer}

\nbdraw{palette_vega}

\nbdraw{palette_sagat}

\nbdraw{palette_bison}

Hint: RKCHGZBD-BVSB.














\section{Graphic system}\index{Systems!Graphics}

% \emph{This section would have been impossible to write without Lo\"{i}c Petit's contribution. He has been working tirelessly on understanding the CPS-1 and CPS-2 and generously shared his knowledge.}

The graphic system is the most complicated to understand in the whole machine. It is complex because it must satisfy three demanding systems.



On one side, there is Control which requests an elaborated composition of backgrounds and sprites to appear on the screen. The description is much more verbose than a simple integer received by the Sound system to play a sample or a music. Communication happens by not only exposing the graphic registers, but also sharing access to a huge portion of "GFX RAM". Control's 68000 writes "draw commands" which the GFX system reads and executes.

On the other side is the 8 MHz Video system which mercilessly demand a pixel color every 125ns. The CRT cannons never wait and a color must be issued on the dot, no matter what. 

Finally there is the GFXROM, a huge repository of up to 12MiB graphic assets. It has a finite latency and throughput which cannot satisfy the Video systems if it were to work on a per-pixel request/response.

Solving these problems of timing and latency well is what made the CPS-1 stand out. It is unarguably the "secret sauce" of the machine GFX system. 

\begin{figure}[H]
\sdraw{0.7}{ppus}
\caption*{Architecture of the CPS-1 Graphic System.}
\end{figure}


\subsection{CPS-A and CPS-B: The ASICs powerhouse}\index{Processors!CPS-A}\index{Processors!CPS-B}
To make their dream machine become a reality, Capcom did not rely on another company's product. They crafted their own ASICs (Application-Specific Integrated Circuit), tailored to their needs, the CPS-A (the head) and CPS-B (the legs).


% The architecture summary shows the heart of GFX is made of not one but two chips called the CPS-A and the CPS-B. 






\subsection{Pens and Ink}
The elementary unit of work is a 4-bit value which is an index into a 16 colors palette. Everything, from backgrounds to sprites uses these 4-bit nibble indexes. A good analogy, and the terminology used in this book, is to picture the GFX manipulating "pens" (palette indexes). The color to appear on the screen is decided not by the pen but by the value at this index, which is called "ink".

This division make the GFX system unaware of the ink that will appear on the CRT since it only manipulates pens.

% All graphic assets in GFXROM are stored one line after another. Pen values are stored in the GFXROM across four bytes in a planar fashion.




Groups of four bytes encoding 8 pens are "tile lines" which combined vertically make a "tile", the elementary unit manipulated by background and sprite layers.

\nbdraw{gfx_format}

 \begin{trivia}
 Pen value \icode{0xF} is always treated as transparent!
 \end{trivia}



\subsection{Elements of drawing}

Games are made of backgrounds on top of which are drawn sprites. The easier to implement are the background circuits. They are studied first, followed by the sprite circuits.

\subsection{Drawing background}

A background is described in terms of "tiles" which arrangement is described in a map. The goal of the circuit is to "rasterize" the map of tiles (called "tilemap").

A naive design would work at the same speed as the video system (8MHz). For each pixel (every 125ns) the GFXRAM would be read to know what tile to display. Then a pen would be retrieved from the GFXROM. Finally that pen would be sent to the palette system where the color would be converted by the video DAC.

 \begin{figure}[H]%
 \nbimg{DL-0311.png}%
 \caption*{CPS-A die. Notice the real estate dedicated to GFXRAM caching.}%
 \end{figure}%

 Even thought the machine uses the fastest type of memory (SRAM), its response time does not permit that many roundtrips. A problem solved via caching, streaming, channeling and an humongous (at that time) 32-bit GFXROM/CPS-B local data bus. 


\subsubsection{Caching}
The CPS-A only accesses the GFXRAM during the HBLANK interval. To eliminate memory read operations while a scanline is rasterized, a whole line worth of tilemap is retrieved and stored in an internal cache of 256 bytes.
%  the CPS-A reads more tilemap than necessary each time it runs out of map. To this effect, it features 256 bytes to cache information retrieved from the GFXRAM during HBLANK.




\subsubsection{Streaming}
Pen values are streamed from GFXROM to the CRT without intermediate storage. The GFXROM data is retrieved eight pen at a time thanks to a 32-bit data bus.

The system works with the GFXROM addresses lines connected to the CPS-A which acts as the brain but the data lines  connected to the CPS-B (the legs) where pen values are selected/discarded before being sent to the video system.

% The grid alignment works well with streaming because of the predictable screen location of the tiles in the map.

 \begin{figure}[H]%
\sdraw{1}{gfx_groups}
 % \caption*{}%
 % \caption*{In Street Fighter 2, a PAL \icode{STF29} decode tiles ids into GFX ROM memory offsets.}%
 \end{figure}%

% Notice how the GFXROM data is retrieved four bytes at a time thanks to a 32-bit data bus. This conveniently accounts for eight pen values.

\subsubsection{Channels}
To further improve response time, the GFXROM data uses a layout where 8 consecutive bytes are interleaved 16 bits at a time across four chips. 

Upon reading, an address is issued to two chips at the same time but their data lines are enabled consecutively. Channeling avoids one "fetch time" every two reads.
 % The  concept is further explained on page \pageref{channels}\index{Channels!Theory}. 

\nbdraw{channels}


\subsection{CPS1 Tilemaps}
The CPS-1 features three tilemap layers named SCROLL1, SCROLL2, and SCROLL3. They all rely on tilemaps made of 64x64 tiles.


\vfill
\begin{figure}[!b]
\img{color-00003208.png}
 \caption*{Street Fighter 2.}%
 \end{figure}%
\pagebreak

SCROLL1 uses tiles of dimensions 8x8 resulting in a total dimensions of 512x512. SCROLL2 uses tiles of dimensions 16x16 resulting in a total dimensions of 1024x1024. SCROLL3 uses tiles of dimensions 32x32 resulting in a total dimensions of 2018x2048.
% A tile is 8 lines of 4 bytes = 64 bytes.

% A tile is 16 lines of 8 bytes = 128 bytes.

% A tile is 32 lines of 16 bytes = 5123 bytes.

Each tilemaps has a maximum capacity of 32 palettes (called a palette page) which any tile can use freely. SCROLLS can be offset by any X or Y value, appear in any order and be used for any purpose.


In Street Fighter 2, different horizontal scroll speed result in parallax. The sprites in black (drawn on a fourth layer called "OBJ") are used not only for the characters but also for the "GUI" elements.

Other titles such as Forgotten World required all the sprites the machine could provide for the gameplay. To avoid wasting any of them, the GUI is implemented with SCROLL1 instead of OBJ. It was a good trade-off because the only restrictions is that elements are aligned on a 8 pixels grid which is not a problem for a GUI.

Color codes used in this section are \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2, \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ.

\vfill
\begin{figure}[!b]
\img{rgb-00003208.png}
 \caption*{Street Fighter 2 ... with layers!}%
 \end{figure}%
\pagebreak


\subsubsection{Starfields}
Besides SCROLLs, the CPS-1 has two "STARfields" layers which are always behind the SCROLLs and always in order STAR1 then STAR2. Alike the other layers, one page of palettes is available to each of them.

To render the stars, the GFXROM contains no tiles but instead bytecode dictating the position of points as well as palette cycling timing.

It is surprising nowadays to see so much silicon dedicated to a "niche" feature. The extreme popularity of R-Type, Gradius, or Darius at the time made a good case for it.
 %  

Providing a system saving both considerable GFXROM space and artists time was a good idea at the time. Ironically, the platform ended up receiving no space shooter! 

Long after STARfield came out of fashion, the system was re-purposed in quite an unexpected fashion.

% The first title released on CPS-1, Forgotten Worlds, prominently showcased its starfields.

% \begin{trivia}
% Alike the tilemaps, each starfield has a dedicated 32 palettes.
% \end{trivia}




\vfill
\begin{figure}[!b]
\img{color_short_forgottn-00000450.png}
 \caption*{Forgotten Worlds. Notice the GUI elements alignment on SCROLL1}%
 \end{figure}%
\pagebreak

\subsubsection{Noir Black}




When designers needed a full black background, instead of using a SCROLL and repeating requesting rows of black tiles to cover the whole screen, they only had to use a STARfield and request no stars for it. 

This is the unknown poesy of Street Fighter Hyper Fighting intro sequence. As the title appears, the black background is in fact a beautiful dark night sky. And nobody ever knew about it.

\begin{trivia}
The layers system does not use a painter algorithm where pixels are written over and over in a framebuffer. The CPS-B receives a stream of all layers and based on the priority and the potential transparent pen value (\icode{0xF}) select the one to be send. The pen value is forwarded directly to the video system.
\end{trivia}


Layers color codes, \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1, \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2, \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3, \fcolorbox{black}{mycyan}{\vphantom{W}\hphantom{H}} STAR1, \fcolorbox{black}{myyellow}{\vphantom{W}\hphantom{H}} STAR2, \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ.

\vfill
\begin{figure}[!b]
\img{rgb_short_forgottn-00000450.png}
 \caption*{Forgotten Worlds.}%
 \end{figure}%
\pagebreak









\subsubsection{Draw order and Priority mask}\label{finalfight_trick}


The drawing order (also called "priority") of SCROLLs and the sprite layer we will see next is entirely configurable (although both STARs must remain behind). Any order can be requested but there is an extra feature available to the SCROLL drawn just behind the sprite layer.

Take the example of Final Fight. After fighting their way in a busy subway, Haggar and Guy find themselves exiting the train station to continue happily brawling in a desolated part of the city. 

As they are going up the stairs, observe in "back to front" order the following layers.

- \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3 used for the skyline.\\
- \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2 used for the main playground.\\
- \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ for the main characters, tires, and barrel sprites.\\
- \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} On top of all, SCROLL1 for the GUI.


\vfill
\begin{figure}[!b]
\img{ff_color-00007375.png}
 \caption*{Final Fight.}%
 \end{figure}%
\pagebreak


It all makes sense except for one detail. If we look closely at Haggar (for those who never played Final Fight, Haggar is the bigger of the two). When he does not workout, he is also a mayor. Anyway.) who appears to be both in front and behind SCROLL2.

To achieve this effect, the CPS-B allows the SCROLL layer behind the OBJs to tag its tiles. Tagged tiles pens are looked up against up to four mask (each allowing for pen values) indicating which pen have precedence over OBJ.

This feature allows to create complex effect where sprites are sandwitched by a SCROLL. In Final Fight, the tiles making the "near" portion of the ramp are tagged to use priority masks. The "wood" tile use one mask using four pens (
\fcolorbox{black}{mask1}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask2}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask3}{\vphantom{W}\hphantom{H}} , and 
\fcolorbox{black}{mask4}{\vphantom{W}\hphantom{H}}). The garbage tiles are tagged to use two masks for a total of eight pens (
\fcolorbox{black}{mask5}{\vphantom{W}\hphantom{H}}  , 
\fcolorbox{black}{mask6}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask7}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask8}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{mask9}{\vphantom{W}\hphantom{H}} ,
\fcolorbox{black}{maska}{\vphantom{W}\hphantom{H}} , 
\fcolorbox{black}{maskb}{\vphantom{W}\hphantom{H}} and  
\fcolorbox{black}{maskc}{\vphantom{W}\hphantom{H}}).

Once the exit animation is over, all tiles are unmarked to allow free roaming and brawling over the whole screen without priority concerns.

Refer to the CPS-B register API on pXXX for more information on tagging and masking.
\vfill
\begin{figure}[!b]
\img{ff_rgb-00007375.png}
 \caption*{Final Fight with SROLL2 layer grid.}%
 \end{figure}%
\pagebreak

\subsubsection{Rowscrolling}
SCROLL 2 has the ability to horizontally offset rows based on their vertical position. 

This capability, commonly known as "rowscroll", is implemented via a table of 1024 10-bit integers (one for each line) in GFXRAM.

This is a feature completely hard-coded in the ASICs. Once requested, the 68000 is uninvolved, it has no awareness of HSYNC, only VSYNC is known.

% \begin{trivia} This feature does not stresses the cache system in the CPS-A because rows are scrolled predictably.
% \end{trivia}
\begin{q}{Akira Nishitani, SF2 Producer}
I knew we had raster scrolling so I talked with the programmers and we gave it a shot.  It was effective. However, to this day I have no idea about what's going on under the hood!
\end{q}

\vfill
\begin{figure}[!b]
\draw{ryu_rowscroll}
 \caption*{Street Fighter 2, Ryu's floor is rowscrolled.}%
 \end{figure}%
\pagebreak

\subsubsection{Choosing features}

The starfield and rowscroll features are good example of how difficult it is to design hardware. Doing it well consist in accurately predicting what will be useful and what won't. 

If starfields were heavily used in the inauguration title, "Forgotten Worlds", and prominently featured in the second one , "Strider", rowscrowl on the other side saw no usage for nearly two years. 

Relegated to implementing flames effects in "Magic Sword" and hazy background in "Carrier Air Wing", rowscrolling was barely used for a few second of gameplay in the five titles\cite{mame_cps1_video} it was featured in.

% STARs were awesome and rowscroll useless.

Ultimately, the balance of these two features found itself reversed when rowscroll was used to implement the notoriously beautiful per-line floor parallax in Street Fighter 2, massively contributing to the graphic appeal of the game.


\vfill
\begin{figure}[!b]
\draw{honda_rowscroll}
% color-00016530.png}
 \caption*{Street Fighter 2, Honda's level is triple rowscrolled.}%
 \end{figure}%
\pagebreak







\subsubsection{Pushing the limits}

Besides priority mask, tiles can be flipped horizontally and/or vertically but there is no scaling or rotation. The CPU has no access to the VRAM which makes it impossible to "plot" pixels. That did not prevent seemingly impossible effects to be achieved.



In Ghouls 'n Ghosts first level, on top of hordes of zombies, a Red Arremer, and unforgiving control, the player must face the weather. Wind picks up and soon come an heavy rains. If you look at the screenshot of the layer below, most layers are used and no rain should be possible.

- \fcolorbox{black}{cyan}{\vphantom{W}\hphantom{H}} STAR1 used for the dark sky.\\
- \fcolorbox{black}{blue}{\vphantom{W}\hphantom{H}} SCROLL3 used for background.\\
- \fcolorbox{black}{green}{\vphantom{W}\hphantom{H}} SCROLL2 used for the playground.\\
- \fcolorbox{black}{black}{\vphantom{W}\hphantom{H}} OBJ for the main character, big rain drops, and enemies.\\
- \fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} On top of all, SCROLL1 for the GUI.\\



\vfill
\begin{figure}[!b]
\img{rgb_ghouls-00009167.png}
 \caption*{Ghouls 'n Ghosts with GUI.}%
 \end{figure}%
\pagebreak

To add rainfall, developers leveraged temporal blending on the same layer as the GUI.
 % (\fcolorbox{black}{red}{\vphantom{W}\hphantom{H}} SCROLL1). 

Every five frames the GUI is not drawn. Instead a full screen of rain tiles is rendered, resulting in a convincing effect. In many games, temporal blending is used to fake translucency. 

In another resourceful trick seen in the intro Carrier Air Wing, pixel plotting was faked. The fizzledade effect of the jet stream is in fact made of pre-rendered tiles.

\draw{fizzlefade}
 

\vfill
\begin{figure}[!b]
\img{rgb_ghouls-00009168.png}
 \caption*{Ghouls 'n Ghosts when rain falls.}%
 \end{figure}%
\pagebreak




\subsection{Drawing Sprites}
Drawing sprites is more difficult than drawing tilemaps. It involves solving the same problem of bandwidth and latency only sprites can appear anywhere on the screen and are not aligned in a grid.

In order to fully appreciate how the Capcom solved this problem, it is worth understanding how other platforms tackled it.

\subsubsection{Hardware sprite}
A sprite circuit can be implemented using the same logic as a tilemap. It is a special case where the map features a single tile and no  horizontally or vertically scrolling is allowed.

Every HSYNC, the GFXRAM is read to know if a sprite appears on the next scanline. If it does, the circuit makes sure it intercept tilemap pens to issue sprite pens instead. 

It is an approach that comes with two drawbacks. Fisrt, it requires one circuit per sprite which is expensive. Second, the one-to-one complexity make it impossible to scale to more than a few units. Nonetheless, this is the solution used by machines such as the Commodore 64 which advertised their circuitry as "hardware sprites".


As limiting as it sounds there is a bit of flexibility thanks to a technique known as multiplexing. A C64 has 8 sprites "units" but that does not mean it can only draw eight sprites on the whole screen. It only means it can only draw eight sprites on the same scanline.

As the CRT progresses down the screen, a sprite unit used above can be reused to draw sprites located lower on the screen. By changing the configuration during HBLANK, many more than eight sprites can be drawn. This trick was extensively in games to reach well over 100 on screen.


Likewise, by using built-in multiplexing, the Commodore Amiga placed an horizontal limit of 8 pixels for its sprites width but allowed unlimited height.

\subsubsection{Line buffer}
To scale better and increase the number of sprites supported, hardware designers introduced the concept of line buffers. 

A linebuffer system requires a buffer as wide as a visible line on the CRT. The buffer is populated with pen codes by a Pixel Processing Unit. The number of sprites, dimensions and rotation capabilities depends on how much work the PPU is able to do. 

The limiting factor is that the line buffer can be written only during HBLANK (16$\mu$s) since it is used the rest of the time to feed the CRT.

System like the Super Nintendo use a line buffer with an impressive PPU resulting in breathtaking fullscreen visuals effects involving Mode-7/HDMA which particularly shun in games like F-Zero or Pilot Wings.








\subsubsection{Double Line buffer}
A straight forward way to make a GFX more powerful is to simply give it more time to do its jobs. The merciless 8MHz pixel clock cannot be cheated but the pipeline can be made deeper.

By using two linebuffers alternatively, the GFX increases its latency but also frees itself from rendering only during HBLANK. While a linebuffer is fed to the video, another one is rendered. This allows drawing during one full scanline (64$\mu$s) and a GFX four times more capable than one using a single line buffer. 

This choice, made by SNK for its Neo-Geo, allowed gorgeous titles such as "Metal Slug" to be build entirely with sprites without using tilemaps. 

This system is so powerful that the entire Neo-Geo rendering pipelien revolves around its double line buffer system. It need no tilemap system.

% The counterpart of this architecture is not only the price of a second line buffer but also an humongous amount of GFX ROM to store the assets which drive up game price tag significantly. 



\subsubsection{CPS1 Sprite FrameBuffer}
Capcom engineers wanted something even more powerful than a double line buffer. To allow more time than the 64$\mu$s allowed by a double line buffer, the CPS-1 was built around a double sprite framebuffer (the same technology as  Sega Super Scaler). To host these framebuffers, the machine uses a dedicated memory called VRAM.

With a double sprite framebuffer, the PPU does not just draw a line in advance but a whole screen. This technique averages 16\% more time per line for the graphic chip to do its work but more importantly it allows any number of tiles per line (even the powerful Neo-Geo has a limit of 96 tiles per line).

% \begin{trivia}
% SEGA X Board used Sprite Framebuffer.
% \end{trivia}

The gain is massive but it comes with three drawbacks. 

\subsubsection{Price tag}
First, the price of the machine goes up since it requires much more buffering capacity. At the resolution of 384*224, 9 bits per pixel are stored (5-bits palette index + 4-bit color index) requiring 100 KiB of storage per framebuffer.

\subsubsection{Bandwidth requirements}
The second impact is on the bus. A massive amount of data is now written and read to/from the VRAM. It requires so much bandwidth that an especially large data bus connecting the GFX ROM and the VRAM had to be designed.

\subsubsection{De-synchronization}
Lastly, there is the problem of tilemap and sprites synchronization. When the m68k writes a layout in the GFXRAM, the graphic system picks it up but routes background tiles and sprites tiles to different locations. The tilemap is rasterized directly towards the video system while the sprite layer is rendered to the VRAM framebuffer where it will be picked up on the next frame.
 

\begin{trivia}
The sync issue is particularly noticeable in Final Fight level 2. The subway wagon moves up and down to simulate rails but inside the handles on the ceiling and the characters appears to lag behind.
\end{trivia}

The issue is visible on the next drawing. On frame 1, the scrolls of frame 1 are displayed. 

\begin{figure}[H]
\nbdraw{latency1}
 \caption*{Frame 1.}%
 \end{figure}%

On frame 2, the scrolls of frame 2 are displayed but along with the spritebuffer from frame 1.
 

\begin{figure}[H]
\nbdraw{latency2}
 \caption*{Frame 2.}%
 \end{figure}%

On frame3, the scrolls of frame 3 are displayed but along with the spritebuffer from frame 2. The desycing can only be compensated in software.

\begin{figure}[H]
\nbdraw{latency3}
 \caption*{Frame 3.}%
 \end{figure}%





\subsubsection{CPS1 Sprites Tile}
With its architecture based on a double sprite framebuffer, Capcom built a powerful system able to move an immense volume of sprites. But performance was only one part of the equation, they also had to come up with a flexible way for artists to use it.

Up to that point, the frustration spur from sprite dimensions (all sprites had to had the same sizes), shapes (mandatory rectangular) and colors (one palette per sprite). 

The CPS-1 lifted these three limitations by abandoning the concept of sprites. The CPS-1 does have a "sprite" layer but it is made of tile of dimensions 16x16 pixels. Called OBJ (for OBJects) its TILEs can be arranged however an artist requires to build sprites of arbitrary shapes and sizes. 

OBJ has 32 palettes which any tile can freely use for a total of 480 colors.

\pagebreak

Street Fighter II embodies the power of the tile system. Combining them creates a universe of rich characters with specific shapes, contributing to building their personality.

\begin{minipage}[t]{0.453\linewidth}
  \sdraw{1.0}{chunLi}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.53\linewidth}
  \sdraw{1.0}{zanghief}
\end{minipage}


% made of 4-bit color index where 0 is always considered transparent. Sprite tile arrangement is described along with SCROLL tiles in the GFXRAM. 

Chunli guard pose, 25 tiles (3,200 bytes). Zanghief standing, 34 tiles (4,352 bytes). 

\begin{minipage}[t]{0.3\linewidth}
  \sdraw{1.0}{ryu}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.53\linewidth}
  \sdraw{1.0}{sagat}
\end{minipage}

Ruy victory pose , 29 tiles (3,712 bytes). Sagat Tiger Punch pose, 30 tiles (3,840 bytes). 



\sdraw{1.0}{kingpin}

The ultimate boss in "The Punisher", Kingpin, is a mountain of a man made of 69 tiles which takes half the screen. This impressive feat came at a zero-wasted space thanks to the malleability of tiles.


Tiles in the OBJ layer can have attributes to be rendered horizontally and/or vertically flipped but there is not support for rotation or scaling.

\begin{minipage}[t]{0.535\linewidth}
  \nbdraw{damnd}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.445\linewidth}
  \nbdraw{damnd2}
\end{minipage}

 When Final Fight boss, Damned, does its back-flip, the CPS-1 does not rotate anything. Two sets of tiles are used and X flip/Y flip generate two extra mirrored sets. The effect works with four poses, thanks to fast movement and players's brain interpolation.

 % The system has an advertised capacity of 256 sprite tile per frame \red{(Source?)}.

\pagebreak

\subsection{OBJ Limitations}
The sprite system has a hard limit of 256 tiles. This is a simple constraint dictated by how many tile is is able to read from the GFXROM and write to the VRAM during a raster scan (16.7ms).

Because OBJ tiles are the most versatile (they can be placed independently and anywhere on the screen), it was tempting to use them often.

Street Fighter II designers pushed the machine on the edge of its limits by using OBJ tiles for the opponents, arena decoration, GUI, and to embellish the background parallax effect.

When Ken faces Ryu in Japan, nearly 200 tiles are used. This high number became an issue in the sequel "Street Fighter 2 Champion Edition" which allowed mirror opponents to face each other on any location.
\vfill
\img{lack_sprites_color.png}
\pagebreak

\begin{q}{Akira Nishitani, SF2 Producer}
We carefully planned SF2 so that the biggest character and the second biggest character could just barely fit on screen at the same time. 

But when mirror matches became possible in Champion Edition, that meant that we had to be able to display two copies of the biggest character on screen. We ended up having to remove back- ground elements and such.
\end{q}
To remain within the OBJ budget, the "wind, forest, fire, mountain" ("\begin{CJK}{UTF8}{min}é¢¨æž—ç«å±±\end{CJK}") sign was removed from Street Fighter 2 Champion Edition. Many more background like XXX, YYY, and ZZZ had to be reworked in the same fashion.

\begin{trivia}
Decoration in Street Fighter 2 were the object of much consideration. The stone in Thailand randomly move at the beginning of each round so they cannot be used as hallmark by players.

\end{trivia}

\vfill
\img{lack_sprites_rgb.png}


\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001209}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001210}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001211}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001212}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001213}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001214}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001215}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001216}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001217}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001218}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001219}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001220}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001221}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001222}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001223}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001224}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001225}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001226}
\end{minipage}


\pagebreak









\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001227}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001228}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001229}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001230}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001231}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001232}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001233}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001234}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001235}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001236}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001237}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001238}
\end{minipage}

\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001239}
\end{minipage}%
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001240}
\end{minipage}
\hfill%
\begin{minipage}[t]{0.32\linewidth}
  \img{sf2frames-00001241}
\end{minipage}

The lack of scaling and rotation was a problem for developers of Street Fighter 2 where the intro called for exactly these operations. 

They faked it with two logos, a small and a large one. Tiles move on a circular pattern. The small to large substitution happens in one-go at the mid-animation timestamp.

\pagebreak











\subsubsection{The World Warrier}
The OBJ system was used in a creative way by Akiman, the lead designer on Street Fighter 2 at the time, to solve a show-stopper bug.

\begin{q}{Akiman, Lead graphic design on SF2}
Just three days before the deadline, I discovered something horrible. 

I had made a mistake with the subtitle â€œWorld Warriorâ€, mis-spelling it â€œWorld Warrier.â€
\end{q}

The subtitle is drawn with the OBJ layer, using 16 draw calls pointing to tileID \icode{0x0}, \icode{0x1}, \icode{0x2}, \icode{0x3}, \icode{0x4}, \icode{0x5}, \icode{0x6}, \icode{0x7}, \icode{0x8}, \icode{0x9}, \icode{0xA}, \icode{0xB}, \icode{0xC}, \icode{0xD}, \icode{0xE}, \icode{0xE}. 

Indeed, looking inside the GFXROM, one can find the 16 tiles making the "World Warrier". 

\begin{figure}[H]
\nbdraw{worldwarrier_tile}
 \caption*{The 16 OBJ tiles making the title. With a typo.}%
 \end{figure}%

\begin{q}{Akiman, Lead graphic design on SF2}
It was several months after all the sprite work had been done. Since the logo had already been created, I couldn't just go in and change the letter at this point.
\end{q}

What Akiman describe is that the GFXROM and all the tiles had been finalized. However they could still make modification to the 68000 instructions and most importantly, the palettes that were stored along with it.

\begin{q}{Akiman, Lead graphic design on SF2}
"Maybe I can just force it to look like an â€˜oâ€™," I thought. I tried layering various other sprites over it until finally, it looked like an â€˜oâ€™. Phew!
\end{q}

\begin{figure}[H]
\img{sf2_title_warrier.png}
 \caption*{A recreation of problem. Ouch!}%
 \end{figure}%



How in the wORld, do you make an 'i' looks like an 'o'? It turns out that Akiman was lucky in the mistake he had made since the letters he needed, 'o' and 'r', can be found in the word "World".

Akiman leveraged what was available and changed the 68000 draw calls to drop the three last tiles and instead draw again tiles \icode{0x6} and \icode{0x7} at the end.

It only partially solved the problem since the spit 'W' looked like an 'l' which made the title read "The World Warrlor". 

\begin{figure}[H]
\nbdraw{world_warrWor}
 \caption*{"The World Warrlor". A little bit better}%
 \end{figure}%


The problem was displaced from turning an 'i' into an 'o', to turning an 'l' into and 'i'. That would have been simple if the CPU could have written in the VRAM but are we have seen these chips are not mapped in the m68k address space.

There is an expensive way to fake pixel plotting. The idea is to find a tile almost fully transparent (\icode{0xF}) but with only a single pen value in it. 

Akiman found that in one of Guile's pose, his calve met these criteria with a simple pen value in its lower left.

\begin{figure}[H]
\nbdraw{guileCalve}
\caption*{Guile's calve save the day.}%
 \end{figure}%

Using Guile's calve as a pencil, but with the title's palette, three tiles are drawn over the 'l' to split it into an 'i'.

\begin{figure}[H]
\nbdraw{palette_guile}
 \caption*{Guile palette.}%
 \end{figure}%

 \begin{figure}[H]
\nbdraw{palette_title}
 \caption*{Title palette.}%
 \end{figure}%


 In an extraordinary coincidence, the pen corresponding colors were a match.

\begin{figure}[H]
\nbdraw{world_warrior_title}
 \caption*{18 draws calls. Two more than necessary but with proper grammar.}%
 \end{figure}%

\begin{figure}[H]
\img{sf2_title.png}
 \caption*{Once you see it, you can't unsee it.}%
 \end{figure}%

% Sometimes, in order to ship, you need to be pragmatic.


\subsection{Putting it all together}

We now have enough knowledge to fully understand how the CPS-A and CPS-B cooperate to render graphics.

The two graphics chips closely work together by sharing custody of the GFX ROM and VRAM. 


 The CPS-A generates four interleaved stream of pens (OBJ, SCR1, SR2, and SRC3) by driving the address bus.
  The CPS-B receives the data and decides for each "pixel" which stream is visible. 


\begin{figure}[H]
\nbdraw{shared_custody}
\caption*{CPS-A (address) and CPS-B (data) GFX ROM/VRAM lines.}
\end{figure}

Besides deciding source and destination of data, the CPS-A also generates LI: (Line increment) and FI: (Frame increment) towards the CPS-B where they are turned into HSYNC and VSYNC for the CRT.

The 23-bit address line to the GFX ROM is special. It is not a raw address but a layerID + tileID within that layer. The PAL \icode{STF29} converts IDs into addresses.


The CPS-B is put under heavy contribution. It must simultaneously write the next sprite framebuffer but also render the current by reading the previous sprite framebuffer and sampling all five other layers.

\nbdraw{vram_rw}

To keep up with the bandwidth requirements, the VRAM and GFX ROM systems are specifically crafted with wide data lines.








\subsubsection{VRAM}
Not only the VRAM system is optimized from an architecture standing point via two completely independents blocks A and B, it also benefit from exceptionally powerful components.

A quick glance at the \icode{HM53461P} pins shows that this chip does more than the simple data, address, and control we have seen so far.

\sdraw{0.6}{HM53461P-10}

Able to store 65,536 Ki x 4-bit, the \icode{HM53461P} is peculiar because it not only features a RAM port (\icode{D1-D4}), it also features a SAM "serial" port (\icode{SD1-SD4}).
 
The RAM port is accessed "normally" by first asserting the address lines along with the control lines and then reading or writing on the data lines.

The SAM port is different. Upon asserting the address lines, an internal buffer is latched. Each subsequent control operation automatically increment the address counter.

This design allows RAM and SAM to be accessed simultaneously (although this never happen since when A is read, B is written and the other way around).
 More interesting is the access time which on the RAM port is 100ms and more than twice as fast (40ms) on the SAM port. 

 This is a perfect component for a system that needs to write a few values at varying locations (like when the CPS-B renders a sprite buffer) but read a very large amount sequentially (like when the CPS-B must compose color code towards the palette system).

 On the Street Fighter II board, twelves \icode{HM53461P} are combined into six pairs, resulting in 384 Ki * 8-bit.

\nbdraw{vram}


% \red{Why so much VRAM? You only need two framebuffer with palette data but there is almost 150 KiB too much there. Could it have been a provision for future improvements?}


% \begin{trivia}
% All memory systems are built with either ROM or SRAM. The VRAM system is the only one built with DRAM and therefore has a memory refresh mechanism.
% \end{trivia}


\subsubsection{GFX ROM}
To keep up with the much higher storage requirements, the GFX ROM system is not designed like the others. 

While other chips on the board-B are \icode{27C010} and \icode{27C512}, the GFXROM is made of \icode{MB834200B} (256 Ki x 16-bit). Because of their slow access time of 150ns, they are arranged in a two-way interleave resulting in two 16-bit "channels" data path.


\sdraw{0.8}{MB834200B-15}

On the Street Fighter II board, twelves \icode{ MB834200B-15} are combined for a total of 6 MiB of GFX assets.

\nbdraw{gfxroms}

% TODO: Talk about channel and how it helped to improve performances of the GFXROM. 

\section{Copy protection system}

Upon release, Capcom then CEO Kenzo Tsujimoto, was confident the CPS-1 would significantly reduce piracy even going as far as labeling it "impossible to copy".

\begin{q}{Kenzo Tsujimoto, Capcom CEO\cite{gamest38}}
    
The new CP System arcade boards are very important to Capcom in two regards. First, they have much more memory than our previous hardware. Game developers will have free reign to explore new, exciting design ideas and take advantage of the latest technological developments. The CP System has upped the level of our developers already.

The second big thing is copy protection. Illegal bootlegs have been a huge problem for us overseas; I believe the CP System is the only PCB hardware today that cannot be copied. The boards contain various copy protection methods, and their advanced hardware should make it difficult for bootleggers seeking to create knockoffs with today's components. 

Bootlegs don't only hurt us; they're also a nuisance for our customers who think they are getting a genuine board. We see copy protection as one of the main achievements of the CP System.
\end{q}


There were good reasons to be optimistic. Engineers had crammed the platform with protections to prevent two types of piracy.


Hardware piracy meant producing bootlegs by physically copying Capcom PCBs. By dumping the ROMs content from a legitimate board, buying the same off-the-shelf CPUs and TTLs components (Transistorâ€“transistor Logic) pirates would sell the same game  for cheaper.

The CPS-1 answer was to use custom components that would not be readily available for purchase, thus preventing counterfeiters from replicating a PCB. Capcom had Ricoh exclusively fabricate the two custom ASICs, the CPS-A and CPS-B. To protect against decapping, metal grids were layered on top of the ASICs\cite{arcadeHackerCPS1Rev}. 


Software piracy involved operators purchasing an authentic game to get the PCBs but then copying ROMs and get newer games for free. 

Capcom's response was a dual verifier with a hardware system that could be actively used by the game runtime to check the board authenticity backed by "passive" mechanisms that allowed the hardware to check the software behavior.

\begin{figure}[H]
\nbimg{copy_protection.png}
\caption*{Capcom's disclaimer when a CPS-1 game boots.}
\end{figure}

\subsection{The ever changing CPS-B}
The heart of the protection system is the CPS-B. The idea is to make it behaves differently depending on the game it is supposed to run.

To this effect, twenty-five versions the CPS-B exist\cite{mame_cps1_video} sometimes differing between revision of the same game\cite{cpsBNumbers}.


\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrrr} 
  \textbf{Game Name} & \textbf{Revision} & \textbf{ CPS-B }  & \textbf{ Year } \\               
  \toprule    
\href{}{Forgotten Worlds} & & \texttt{CPS-B-01} & 1988 \\ 
\href{}{Lost Worlds} & & \texttt{CPS-B-01} & 1988 \\ 
\href{}{Ghouls'n Ghosts} & & \texttt{CPS-B-01} & 1988 \\ 
  \toprule    
\href{}{Strider} & & \texttt{CPS-B-01} & 1989 \\ 
\href{}{Dynasty Wars} & & \texttt{CPS-B-02} & 1989 \\ 
\href{}{Willow} & & \texttt{CPS-B-03} & 1989 \\ 
\href{}{U.N Squadron} & & \texttt{CPS-B-11}   & 1989 \\ 

\href{}{Final Fight } & \texttt{Original} & \texttt{CPS-B-04} & 1989 \\ %ffight
\href{}{Final Fight } & \texttt{900112}& \texttt{CPS-B-01} & 1989 \\ %ffightua
\href{}{Final Fight } & \texttt{900424}& \texttt{CPS-B-03} & 1989 \\ %ffightub
\href{}{Final Fight } & \texttt{900613}& \texttt{CPS-B-05} & 1989 \\ %ffightuc

  \toprule    
\href{}{1941: Counter Attack} & & \texttt{CPS-B-05} &  1990 \\ 
\href{}{Mercs} & &  \texttt{CPS-B-12} & 1990 \\ 
\href{}{Mega Twins} & & \texttt{CPS-B-14} & 1990 \\ 
\href{}{Magic Sword} & & \texttt{CPS-B-13} & 1990 \\ 
\href{}{Carrier Air Wing} & & \texttt{CPS-B-16}  & 1990 \\ 
\href{}{Nemo} & & \texttt{CPS-B-15} &  1990 \\ 
  \toprule    
\href{}{Street Fighter II: The World Warrior }&  \texttt{Original}& \texttt{CPS-B-1}1 & 1991 \\  %sf2
\href{}{Street Fighter II: The World Warrior } & \texttt{910204}& \texttt{CPS-B-17} & 1991 \\  %sf2ea
\href{}{Street Fighter II: The World Warrior } & \texttt{910318}& \texttt{CPS-B-05} & 1991 \\  %sf2ed
\href{}{Street Fighter II: The World Warrior } & \texttt{910228}& \texttt{CPS-B-18} & 1991 \\  %sf2ee
\href{}{Street Fighter II: The World Warrior } & \texttt{910411}& \texttt{CPS-B-15} & 1991 \\  %sf2ef
\toprule    
\end{tabularx}%
}\caption*{A selection of the many Capcom CPS-1 games revisions.}
\end{figure}

Originally, the CPS-B chips changed frequently. The table above only contains a few of the many PCB revisions. The full list give a good idea of how successful a game was. Street Fighter 2 was revised 34 times, while Final Fight received 13 "refreshes".

With the released of "Three Wonders", Capcom singled out their chips via configuration micro-code so all CPS-B ASICs onward were CPS-B v21.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrr} 
  \textbf{Game Name} & \textbf{ CPS-B }  & \textbf{ Year } \\               
  \toprule    
\href{}{Three Wonders} &  \texttt{CPS-B-21} & 1991 \\ 
\href{}{The King of Dragons} &  \texttt{CPS-B-21} &1991 \\ 
\href{}{Captain Commando} &  \texttt{CPS-B-21} & 1991 \\ 
\href{}{Knights of the Round} &  \texttt{CPS-B-21} &1991 \\ 
  \toprule    
\href{}{Street Fighter II: Champion Edition} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Adventure Quiz: Capcom World 2} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Varth: Operation Thunderstorm} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Quiz \& Dragons: Capcom Quiz Game} &  \texttt{CPS-B-21} &1992 \\ 
\href{}{Street Fighter II' Turbo: Hyper Fighting} &  \texttt{CPS-B-21} & 1992 \\ 
  \toprule    
\href{}{Ken Sei Mogura: Street Fighter II} &  \texttt{CPS-B-21} &1993 \\ 
\href{}{Pnickies} &  \texttt{CPS-B-21} &1993 \\ 
  \toprule    
\href{}{Quiz Tonosama no Yabo 2} &  \texttt{CPS-B-21} & 1995 \\ 
\href{}{Pang! 3} & \texttt{CPS-B-21}  & 1995 \\ 
Mega Man the Power Battle & \texttt{CPS-B-21}  & 1995 \\

\toprule    
\end{tabularx}%
}\caption*{After 1991, all CPS-1 games used CPS-B v21.}
\end{figure}


\subsection{CPS-ID check}
The simplest copy protection available is the chip ID check. By polling a register, the m68k prompts the CPS-B to return its version number. A simple version matches let the code know if its belongs to the right PCB. 

To make instructions patching of the 68000 ROMs more difficult, calls to verify the chip id are placed in several location in the code. That did not prevent people from trying anyway\cite{strider_conversion}!

\subsection{Multiplication check}
Starting with vB-21, a slightly more robust feature gave the CPS-B the ability to perform multiplications. Two registers are written and a third one can be read. The 68000 code is expected to check that the returned multiplication result is the expected value.

\subsection{Unexpected behavior detection}
Protection described so far involved an active software and a passive hardware. There is yet another level of protection where the hardware is active by expecting the software to behave properly. If the CPS-B sees that incoherent values are written to the wrong register, it sets and lock all palettes to black. 

The game still runs in the background and the audio is also behaving properly but the screen doesn't display anything. The only way to recover is to reboot the machine\cite{petitSecurity}.

\subsection{Moving registers}
Another variation between CPS-Bs is the registers locations. The 68000 memory map of the CPS-B registers does not change, but the offset inside that mapping was altered between versions. Accessing the scroll control, scroll priority, and palette upload registers is done using a different offset for each game.

Additionally, the meaning of each bit inside a register can changes.






\subsection{Invalid offset detection}

Each game uses a different amount of assets for each of its SCROLL and OBJ layers. On the "B" board, PAL chips such as the \icode{STF29} discussed earlier are hard-coded with knowledge of the amount of GFX ROM attributed to each layers.

Tile references pointing beyond a range are ignored resulting in rendering "holes" if a game ROMs are inserted in a non-matching "B" board.

\begin{q}{Mame cps-1 video driver}
All graphics are
stored together in the same ROMs.

But the hardware knows which part of the ROM space
is 8x8 tiles, 16x16 tiles, 16x16 spites, 32x32 tiles, and all games tested only
draw tiles if their code falls in the valid range. 

If a tile is out of range, it is replaced by transparent pixels.
\end{q}

\begin{trivia}
Pull-up resistors on the board along the GFX ROM data lines detect if a pen value matches a tileID. 

If not data is detected, \icode{0xF} is automatically "inserted", resulting in a transparent value.
\end{trivia}



\subsection{Configuration Key}
Up to 1991, all CPS-B variations were burned at the factory. They were set in silicon without a way to re-purpose them after the fact. This was not only expensive to have to revise the hardware circuits for each game, it was also a logistic difficulty to provision enough chips for a success and not be stuck with inventory on an unappreciated game.

To solve this issue, Capcom resolved to stop making different silicon in favor of using a standard configurable CPS1-B.

"Street Fighter 2: The World Warriors" did not get the treatment but starting with "Three Wonders" the CPS-B v21 featured a small internal 18 bytes RAM. This was enough for the chip to retain a configuration dictating its behavior\cite{petitSecurity}.

The configuration RAM was designed to survive when the cabinet was turned off thanks to a battery located  on the soldering side of Board C and connected to the CPS-B. The chip was even designed to survive having no battery for a few minutes to allow battery replacement.

\begin{trivia}
These battery worked remarkably well since thirty years later you can still find some of these boards in working condition.
\end{trivia}

\subsection{Suicide batteries}
The infamous "suicide" nickname came from the effect of losing power. A CPS-B v21 without power lose its configuration and resets all its registers to "default" values that none of the games use. Capcom offered a battery replacement to resurrect boards "C" which had committed sepuku but eventually discontinued the service. 

As the reader will have guessed, passionate fans found a way to bring these games back to life.

\subsubsection{Phonenixing}
The first method is called "phoenix". It is a tedious process which consist in dumping a game ROM and patch the m68k instructions to replace CPS-B registers accesses to use the "default values"\cite{csp1_phoenix}. 

The people phoenixing CPS-1 board are so good at it that they even change the splash screen of the game to feature a "Phoenix Edition" icon.

\subsubsection{De-suiciding}
The second method is even more impressive since it involves circuit surgery by re-uploading the configuration into the CPB-B, essentially de-suiciding them\cite{arcadeHackerCPS1Desuicide}.

\nbimg{phoenix_screen.png}





\section{Epilogue}
From 1988 to 1995, Capcom used the CPS-1 to release thirty+ titles. These seven years saw the birth of three of Capcom most loved franchise, Ghoulsâ€™n Ghosts, Final Fight, and Street Fighter 2.

To Capcom, the CPS-1 was a gamble that paid off hundredfold, allowing them to become a video-game household. 

To players, the games were a series of beautifully crafted titles which provided entertainment and empty pockets. The unforgettable experience was such that passionate people wrote emulators and even in some extreme cases, books to keep these memories alive. 

To counterfeiters, the CP System was a problem. Capcom games were popular and generated a substantial amount of money. The demand for boards skyrocketed with the advent of Street Fighter II. 

Capcom engineers had designed security measures able to discourage attackers with a reasonable amount of determination. Perhaps the one flaw the CPS-1 can be faulted with is that it did not provision for the high level of success it enjoyed.

The money in the balance armed the counterfeiters with an unreasonable amount of determination. As players lined up to spend time and beat Street Fighter 2, so did the pirates to defeat the copy-protection systems. Eventually they were able to figure out. 


Of all the security measures, it would have been fair to assume the custom ASICs would be an impenetrable fortress. Astonishingly, CPS-A and CPS-B replicas were manufactured under the name "COMCO"\cite{arcadeHackerCPS1}. It is unknown if an insider leaked the schematics or if someone made it their life mission to reverse-engineer these chips but it did happen.

As cracks appeared in its shield, Capcom did not give up on protecting its tiles. As it had proved itself able to evolve and compete in the arcades, it embraced the challenge to always remain one step ahead of bootlegers.

\subsection{CPS-1.5 Kabuki}
In 1992, Capcom released the CP System Dash (a.k.a CPS-1.5). Fully encased in a gray plastic box, it introduced a fourth satellite "Qboard" PCB to handle playback of positional three-dimensional Qsound audio. In total, five games would be produced until late 1993.

\begin{figure}[H]
{ \setlength{\tabcolsep}{3.0pt}
\begin{tabularx}{\textwidth}{Xrr}
  \toprule    
  \textbf{Game Name} & \textbf{ GFX }  & \textbf{ Year } \\               
  \toprule    
\href{}{Cadillacs and Dinosaurs} & 4 MiB & 1992 \\ 
\href{}{Warriors of Fate} & 4 MiB & 1992 \\ 
\href{}{The Punisher} & 4 MiB & 1993 \\ 
\href{}{Saturday Night Slam Masters} & 6 MiB & 1993 \\ 
\href{}{Muscle Bomber Duo: Ultimate Team Battle} & 6 MiB & 1993 \\ 
  \toprule    
\end{tabularx}%
}\caption*{Capcom CPS-1.5 based arcades games.}
\end{figure}

\label{kabuki}
The CPS 1.5 is noteworthy for its improved copy-protection where the audio instructions are stored in encrypted ROM. The audio CPU is a special z80 dubbed Kabuki\cite{arcadeHackerKabuki} able to decrypt instructions on the fly.

The encryption scheme is symmetric with the private key being stored in the z80. It is not burned in the silicon but, alike the CPS-1 configuration, stored via RAM. To keep that key alive, the unused pin 28 we saw on page \pageref{z80_pinRFSH} is re-purposed from "DRAM refresh" to providing power. To this effect, it is connected to a second "suicide battery" (not the same as the CPS-Bs). 





\begin{trivia}
The protection provided by CPS-1.5 held remarkably well over the years. It was only broken in the early 2000s\cite{mame_kabuki}.
\end{trivia}

\subsection{CPS-2}

With significantly improved capabilities thanks to its increased ROM capacity and higher processor clocks the CPS-2 instantly became a smash-hit, in particular thanks to the Street Fighter Alpha series. 

From 1993 to 2003, forty-two games would be published, the last one being "Hyper Street Fighter II: The Anniversary Edition".

In terms of copy-protection, Capcom once again cranked up security. Not only the platform features the Kabuki audio instruction encryption, it also features encrypted game logic. 

Thanks to a custom CPU, ABI compatible with the 68000, instructions retrieved from the ROM can be decrypted on the fly. Alike other systems, the private key is stored in yet another battery-powered RAM.

The only part of the machine that remain non-encrypted is the OKI ROM containing audio samples,. The GFXROM data was not encrypted but the content was shuffled.

\begin{trivia}
This protection was remarkably strong and held for nearly 10 years. It only fell when the "CPS-2 Shock Group" attacked it in 2003\cite{cps2rebirth}.
\end{trivia}



